<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Расписание МГУ — SPA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            color-scheme: light dark;
            --accent: #1d4ed8;
            --accent-dark: #1e3a8a;
            --bg: #f8fafc;
            --background: #f8fafc;
            --card: #ffffff;
            --surface: #ffffff;
            --border: #d8dee9;
            --text: #0f172a;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --muted: #64748b;
            --muted-bg: #e2e8f0;
            --surface-hover: rgba(0, 0, 0, 0.05);
            --safe-area-bottom: var(--tg-safe-area-inset-bottom, env(safe-area-inset-bottom, 0px));
            --safe-area-top: var(--tg-safe-area-inset-top, env(safe-area-inset-top, 0px));
            --tg-header-height: var(--tg-viewport-height, 0px);
            --tg-controls-height: 44px; /* Высота кнопок управления Telegram */
            --header-gradient-height: calc(160px + var(--safe-area-top));
            --tabbar-bg: rgba(255, 255, 255, 0.9);
            --tabbar-border: var(--border);
            --tabbar-shadow: 0 -18px 38px -30px rgba(15, 23, 42, 0.2);
            --tab-item-bg: var(--card);
            --tab-item-border: var(--border);
            --tab-item-color: var(--muted);
            --tab-item-hover-border: rgba(59, 130, 246, 0.25);
            --tab-item-active-bg: linear-gradient(135deg, rgba(29, 78, 216, 0.15), rgba(59, 130, 246, 0.1));
            --tab-item-active-border: var(--accent);
            --tab-item-active-shadow: 0 8px 25px -8px rgba(29, 78, 216, 0.4), 0 0 0 1px rgba(29, 78, 216, 0.2);
            --tab-item-primary-bg: var(--card);
            --tab-item-primary-color: var(--muted);
            --tab-item-primary-active-bg: linear-gradient(135deg, var(--accent), var(--accent-dark));
            --tab-item-primary-active-color: #fff;
            --tab-item-primary-active-shadow: 0 24px 46px -28px rgba(29, 78, 216, 0.6);
        }
        :root[data-theme="dark"] {
            --accent: #1e293b;
            --accent-dark: #0b1220;
            --bg: #030712;
            --card: #0f172a;
            --border: #1f2a3d;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --muted-bg: #17233a;
            --tabbar-bg: rgba(4, 9, 20, 0.94);
            --tabbar-border: rgba(148, 163, 184, 0.25);
            --tabbar-shadow: 0 -22px 48px -32px rgba(2, 6, 23, 0.85);
            --tab-item-bg: rgba(15, 23, 42, 0.88);
            --tab-item-border: rgba(59, 76, 111, 0.35);
            --tab-item-color: rgba(148, 163, 184, 0.9);
            --tab-item-hover-border: rgba(96, 165, 250, 0.4);
            --tab-item-active-bg: linear-gradient(135deg, rgba(37, 99, 235, 0.25), rgba(59, 130, 246, 0.15));
            --tab-item-active-border: rgba(96, 165, 250, 0.6);
            --tab-item-active-shadow: 0 8px 25px -8px rgba(37, 99, 235, 0.5), 0 0 0 1px rgba(96, 165, 250, 0.3);
            --tab-item-primary-bg: rgba(11, 17, 32, 0.96);
            --tab-item-primary-color: rgba(191, 219, 254, 0.85);
            --tab-item-primary-active-bg: linear-gradient(135deg, #2563eb, #1e3a8a);
            --tab-item-primary-active-color: #fff;
            --tab-item-primary-active-shadow: 0 24px 46px -28px rgba(37, 99, 235, 0.65);
        }
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --accent: #1e293b;
                --accent-dark: #0b1220;
                --bg: #030712;
                --card: #0f172a;
                --border: #1f2a3d;
                --text: #e2e8f0;
                --muted: #94a3b8;
                --muted-bg: #17233a;
                --tabbar-bg: rgba(4, 9, 20, 0.94);
                --tabbar-border: rgba(148, 163, 184, 0.25);
                --tabbar-shadow: 0 -22px 48px -32px rgba(2, 6, 23, 0.85);
                --tab-item-bg: rgba(15, 23, 42, 0.88);
                --tab-item-border: rgba(59, 76, 111, 0.35);
                --tab-item-color: rgba(148, 163, 184, 0.9);
                --tab-item-hover-border: rgba(96, 165, 250, 0.4);
                --tab-item-active-bg: linear-gradient(135deg, rgba(37, 99, 235, 0.25), rgba(59, 130, 246, 0.15));
                --tab-item-active-border: rgba(96, 165, 250, 0.6);
                --tab-item-active-shadow: 0 8px 25px -8px rgba(37, 99, 235, 0.5), 0 0 0 1px rgba(96, 165, 250, 0.3);
                --tab-item-primary-bg: rgba(11, 17, 32, 0.96);
                --tab-item-primary-color: rgba(191, 219, 254, 0.85);
                --tab-item-primary-active-bg: linear-gradient(135deg, #2563eb, #1e3a8a);
                --tab-item-primary-active-color: #fff;
                --tab-item-primary-active-shadow: 0 24px 46px -28px rgba(37, 99, 235, 0.65);
            }
            :root:not([data-theme]) body {
                background: linear-gradient(135deg, var(--accent), var(--accent-dark)) 0 0 / 100% var(--header-gradient-height) no-repeat, var(--bg);
                color: var(--text);
            }
            :root:not([data-theme]) .panel,
            :root:not([data-theme]) .day-block,
            :root:not([data-theme]) .pair-card {
                background: var(--card);
                border-color: var(--border);
            }
            :root:not([data-theme]) .pair-card.empty {
                background: var(--muted-bg);
                color: var(--muted);
            }
            :root:not([data-theme]) select,
            :root:not([data-theme]) input[type="date"] {
                background: #1f2937;
                color: var(--text);
                border: none;
            }
            :root:not([data-theme]) button.primary {
                background: linear-gradient(135deg, var(--accent), var(--accent-dark));
                color: var(--text);
            }
            :root:not([data-theme]) .badge {
                background: rgba(59, 130, 246, 0.35);
                color: #dbeafe;
            }
        }
        html, body {
            height: 100%;
        }
        .app-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        * {
            box-sizing: border-box;
        }
        
        /* Плавные переходы для всех элементов при смене темы */
        .theme-animations-enabled * {
            transition: background-color 0.3s ease, 
                       color 0.3s ease, 
                       border-color 0.3s ease, 
                       box-shadow 0.3s ease;
        }
        
        /* Специальные переходы для сложных элементов */
        .theme-animations-enabled body {
            transition: background 0.3s ease;
        }
        
        .theme-animations-enabled .app-header {
            transition: background 0.3s ease;
        }
        
        .theme-animations-enabled .day-header {
            transition: background 0.3s ease;
        }
        
        .theme-animations-enabled .panel, 
        .theme-animations-enabled .day-block, 
        .theme-animations-enabled .pair-card {
            transition: background-color 0.3s ease, 
                       border-color 0.3s ease, 
                       box-shadow 0.3s ease;
        }
        
        .theme-animations-enabled .tabbar {
            transition: background 0.3s ease, 
                       border-color 0.3s ease, 
                       box-shadow 0.3s ease;
        }
        
        .theme-animations-enabled .tab-item {
            transition: background-color 0.3s ease, 
                       color 0.3s ease, 
                       border-color 0.3s ease, 
                       box-shadow 0.3s ease;
        }
        
        .theme-animations-enabled .toggle-slider {
            transition: background-color 0.3s ease, 
                       box-shadow 0.3s ease;
        }
        
        .theme-animations-enabled .toggle-slider:before {
            transition: transform 0.3s ease, 
                       box-shadow 0.3s ease;
        }
        body {
            margin: 0;
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark)) 0 0 / 100% var(--header-gradient-height) no-repeat, var(--bg);
            color: var(--text);
        }
        :root[data-theme="dark"] body {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark)) 0 0 / 100% var(--header-gradient-height) no-repeat, var(--bg);
            color: var(--text);
        }
        .app-header {
            min-height: var(--header-gradient-height);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-start;
            gap: 0.35rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: #fff;
            padding: 1rem 1rem 1.8rem;
            padding-top: calc(1rem + var(--safe-area-top));
            text-align: left;
            position: relative;
        }
        
        .app-header__content {
            flex: 1;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: flex-end;
            gap: 1rem;
        }

        .app-header__main {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 0.35rem;
            flex: 1;
        }
        .app-header__title {
            margin: 0;
            font-size: clamp(1.9rem, 2.8vw + 1.3rem, 2.9rem);
            font-weight: 700;
        }
        .app-header__subtitle {
            margin: 0;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.78);
        }
        .app-header__subtitle.hidden {
            display: none;
        }
        
        /* User Info Styles */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-avatar-placeholder {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
        }
        
        .user-role {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.15);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            display: inline-block;
        }
        
        /* Auth Modal Styles */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .auth-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .auth-modal-content {
            position: relative;
            background: var(--card);
            border-radius: 16px;
            padding: 2rem;
            margin: 1rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .auth-modal-content h3 {
            margin: 0 0 1rem 0;
            color: var(--text);
            font-size: 1.5rem;
        }
        
        .auth-modal-content p {
            margin: 0 0 1.5rem 0;
            color: var(--muted);
            line-height: 1.5;
        }
        
        .auth-telegram-btn, .auth-test-btn, .auth-admin-btn {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .auth-telegram-btn {
            background: #0088cc;
            color: white;
        }
        
        .auth-telegram-btn:hover {
            background: #006ba3;
        }
        
        .auth-test-btn {
            background: var(--muted-bg);
            color: var(--text);
        }
        
        .auth-test-btn:hover {
            background: var(--border);
        }
        
        .auth-admin-btn {
            background: #8b5cf6;
            color: white;
        }
        
        .auth-admin-btn:hover {
            background: #7c3aed;
        }
        
        /* Homework Display Styles */
        .homework-display {
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(29, 78, 216, 0.08), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(29, 78, 216, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.4;
            position: relative;
        }
        
        .homework-display::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent);
            border-radius: 2px 0 0 2px;
        }
        
        .homework-display strong {
            color: var(--accent);
            font-weight: 600;
        }
        
        .add-homework-btn {
            display: none;
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            justify-self: start;
            align-self: start;
        }
        
        .add-homework-btn:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(29, 78, 216, 0.3);
        }
        
        .add-homework-btn:active {
            transform: translateY(0);
        }
        
        /* Стили для кнопки внутри пары */
        .pair-card .add-homework-btn {
            margin-top: 0.5rem;
            margin-left: 0;
            margin-right: 0;
        }
        
        /* User Management Panel Styles */
        .user-management-panel {
            margin-top: 0.5rem;
        }
        
        .manage-users-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .manage-users-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        /* User Management Modal Styles */
        .user-management-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .user-management-modal.show {
            display: flex;
        }
        
        .user-management-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .user-management-modal-content {
            position: relative;
            background: var(--card);
            border-radius: 16px;
            padding: 0;
            margin: 1rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .user-management-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .user-management-modal-header h3 {
            margin: 0;
            color: var(--text);
        }
        
        .user-management-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
            padding: 0.25rem;
            border-radius: 4px;
        }
        
        .user-management-modal-close:hover {
            background: var(--muted-bg);
        }
        
        .user-management-modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .user-list {
            margin-bottom: 2rem;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--card);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .user-details-small {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .user-name-small {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }
        
        .user-role-small {
            font-size: 0.8rem;
            color: var(--muted);
            background: var(--muted-bg);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            display: inline-block;
        }
        
        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .role-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .role-btn.monitor {
            background: var(--accent);
            color: white;
        }
        
        .role-btn.student {
            background: var(--muted-bg);
            color: var(--text);
        }
        
        .role-btn:hover {
            opacity: 0.8;
        }
        
        .add-user-section {
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }
        
        .add-user-section h4 {
            margin: 0 0 1rem 0;
            color: var(--text);
        }
        
        .add-user-form {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .add-user-form input,
        .add-user-form select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card);
            color: var(--text);
        }
        
        .add-user-form input {
            flex: 1;
        }
        
        .add-user-form select {
            min-width: 120px;
        }
        
        .add-user-form button {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .add-user-form button:hover {
            background: var(--accent-dark);
        }
        
        /* User Info in Settings */
        .user-info-settings {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--muted-bg);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .user-avatar-settings {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .user-avatar-settings img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-details-settings {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            flex: 1;
        }
        
        .user-name-settings {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .user-role-settings {
            font-size: 0.9rem;
            color: var(--muted);
            background: var(--accent);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            display: inline-block;
            font-weight: 500;
        }
        
        .user-id-settings {
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 0.2rem;
        }
        
        .user-group-settings {
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 0.2rem;
        }
        
        .user-management-panel-settings {
            margin-top: 0.5rem;
        }
        
        .manage-users-btn-settings {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .manage-users-btn-settings:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
        }
        
        .user-actions-settings {
            margin-top: 1rem;
        }
        
        .logout-btn-settings {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .logout-btn-settings:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        /* Admin Panel Styles */
        .admin-panel-settings {
            margin-top: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 8px;
        }
        
        .admin-panel-settings h4 {
            margin: 0 0 1rem 0;
            color: #8b5cf6;
            font-size: 1rem;
            font-weight: 600;
        }
        
        /* Notifications Section Styles */
        .notifications-section-settings {
            margin-top: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
        }
        
        .notifications-section-settings h4 {
            margin: 0 0 1rem 0;
            color: #3b82f6;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .settings-panel .menu-entry {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
        }
        
        .settings-panel .menu-entry:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .settings-panel .menu-icon {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        
        .settings-panel .menu-text {
            flex: 1;
            color: var(--text);
            font-weight: 500;
        }
        
        .settings-panel .menu-arrow {
            color: var(--muted);
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .admin-btn-settings {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
        }
        
        .admin-btn-settings:hover {
            background: #7c3aed;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .admin-btn-settings:last-child {
            margin-bottom: 0;
        }
        
        /* Groups Modal Styles */
        .groups-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .group-item {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--muted-bg);
        }
        
        .group-item:last-child {
            margin-bottom: 0;
        }
        
        .group-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text);
            font-size: 1.1rem;
        }
        
        .group-info p {
            margin: 0.25rem 0;
            color: var(--muted);
            font-size: 0.9rem;
        }
        
        .hidden {
            display: none !important;
        }

        /* Welcome Modal Styles */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .welcome-modal__overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .welcome-modal__content {
            position: relative;
            background: var(--card);
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: welcomeModalSlideIn 0.3s ease-out;
        }

        @keyframes welcomeModalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes welcomeModalSlideOut {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
        }

        .welcome-modal__header {
            padding: calc(2rem + var(--safe-area-top)) 1.5rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .welcome-modal__title {
            margin: 0 0 0.5rem;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
        }

        .welcome-modal__subtitle {
            margin: 0;
            color: var(--muted);
            font-size: 1rem;
        }

        .welcome-modal__body {
            padding: 1.5rem 1.5rem;
        }

        .welcome-modal__steps {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .welcome-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--muted-bg);
            border-radius: 12px;
            transition: all 0.3s ease;
            opacity: 0.5;
        }

        .welcome-step.active {
            opacity: 1;
            background: linear-gradient(135deg, rgba(29, 78, 216, 0.1), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(29, 78, 216, 0.2);
        }

        .welcome-step.completed {
            opacity: 0.8;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .welcome-step__number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .welcome-step.completed .welcome-step__number {
            background: #22c55e;
        }

        .welcome-step__content h3 {
            margin: 0 0 0.25rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        .welcome-step__content p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--muted);
        }

        .welcome-modal__form {
            margin-bottom: 2rem;
        }

        .welcome-modal__form .field {
            margin-bottom: 1.5rem;
        }

        .welcome-modal__form .field:last-child {
            margin-bottom: 0;
        }

        .welcome-modal__features {
            margin-bottom: 1.5rem;
        }

        .welcome-modal__features h3 {
            margin: 0 0 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }

        .features-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--muted-bg);
            border-radius: 8px;
        }

        .feature-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .feature-text strong {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .feature-text p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .welcome-modal__footer {
            padding: 1rem 1.5rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .welcome-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .welcome-btn--primary {
            background: var(--accent);
            color: white;
        }

        .welcome-btn--primary:hover:not(:disabled) {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        .welcome-btn--primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .welcome-btn--secondary {
            background: var(--muted-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .welcome-btn--secondary:hover {
            background: var(--border);
            transform: translateY(-1px);
        }

        /* Dark theme adjustments for welcome modal */
        :root[data-theme="dark"] .welcome-modal__content {
            background: var(--card);
            border: 1px solid var(--border);
        }

        :root[data-theme="dark"] .welcome-step {
            background: var(--muted-bg);
        }

        :root[data-theme="dark"] .feature-item {
            background: var(--muted-bg);
        }
        main {
            flex: 1;
            width: 100%;
            padding: 1.25rem 1rem calc(6rem + var(--safe-area-bottom));
            max-width: 1100px;
            margin: 0 auto;
        }
        h1 {
            margin: 0 0 0.65rem;
            font-size: clamp(1.75rem, 2.5vw + 1.25rem, 2.75rem);
        }
        p.lead {
            margin: 0;
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.05rem;
        }
        .panel {
            background: var(--card);
            border-radius: 18px;
            box-shadow: 0 22px 55px -30px rgba(15, 23, 42, 0.4);
            padding: 1.2rem 1.5rem 1.5rem;
        }
        .filters {
            display: grid;
            gap: 1.15rem;
        }
        .field {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 0.4rem;
        }
        select,
        input[type="date"],
        button {
            border-radius: 10px;
            border: 1px solid #d0d5dd;
            padding: 0.7rem 0.8rem;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
            font-family: inherit;
        }
        :root[data-theme="dark"] select,
        :root[data-theme="dark"] input[type="date"] {
            background: #1f2937;
            color: var(--text);
            border: none;
        }
        select:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.16);
        }
        button.primary {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        :root[data-theme="dark"] button.primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--text);
        }
        button.primary:hover:not(:disabled) {
            background: var(--accent-dark);
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }

        /* Settings Container */
        .settings-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
        }

        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }


        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        /* Settings Grid */
        .settings-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--background);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .setting-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex: 1;
            text-align: left;
        }

        .setting-info label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            text-align: left;
        }


        .setting-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
            text-align: left;
        }



        /* Setting Select */
        .setting-select {
            background: var(--background);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            min-width: 120px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 32px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--muted-bg);
            border: 1px solid var(--border);
            border-radius: 32px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: #ffffff;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-color: var(--accent);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(29, 78, 216, 0.1);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(28px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch:hover .toggle-slider {
            border-color: var(--accent);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(29, 78, 216, 0.05);
        }

        .toggle-switch:hover input:checked + .toggle-slider {
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(29, 78, 216, 0.15);
        }

        /* Dark theme adjustments for toggle */
        :root[data-theme="dark"] .toggle-slider {
            background-color: var(--muted-bg);
            border-color: var(--border);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        :root[data-theme="dark"] .toggle-slider:before {
            background-color: #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        :root[data-theme="dark"] .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #2563eb, #1e3a8a);
            border-color: #2563eb;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        :root[data-theme="dark"] .toggle-switch:hover .toggle-slider {
            border-color: #2563eb;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        :root[data-theme="dark"] .toggle-switch:hover input:checked + .toggle-slider {
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        /* Disabled toggle switch styles */
        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toggle-switch input:disabled + .toggle-slider:before {
            opacity: 0.7;
        }

        .toggle-switch:hover input:disabled + .toggle-slider {
            border-color: var(--border);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }



        /* Font Size Styles */
        [data-font-size="small"] {
            font-size: 0.875rem;
        }
        [data-font-size="small"] .section-title {
            font-size: 1.1rem;
        }
        [data-font-size="small"] .setting-description {
            font-size: 0.8rem;
        }

        [data-font-size="large"] {
            font-size: 1.125rem;
        }
        [data-font-size="large"] .section-title {
            font-size: 1.4rem;
        }
        [data-font-size="large"] .setting-description {
            font-size: 1rem;
        }
        [data-font-size="large"] .pair-card {
            padding: 1.2rem 1.4rem;
        }

        .actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .status {
            margin-top: 1rem;
            min-height: 1.5rem;
            color: var(--muted);
        }
        .schedule-wrapper {
            margin-top: 1.5rem;
            position: relative;
        }
        .schedule-days {
            display: grid;
            gap: 2rem;
        }
        .schedule-days.hidden {
            display: none;
        }
        .day-block {
            background: var(--card);
            border-radius: 18px;
            padding: 1.2rem 1.5rem 1.5rem;
            box-shadow: 0 20px 50px -32px rgba(15, 23, 42, 0.45);
        }
        .day-header {
            margin: -1.2rem -1.5rem 1.2rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: #fff;
            border-radius: 18px 18px 14px 14px;
        }
        .day-header h2 {
            color: inherit;
            margin: 0;
            font-size: 1.35rem;
            font-weight: 700;
        }
        .pair-list {
            display: grid;
            gap: 1rem;
        }
        .pair-card {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1rem 1.15rem;
            background: var(--card);
            display: grid;
            gap: 0.55rem;
            transition: border-color 0.15s ease;
        }
        .pair-card:not(.empty):hover {
            border-color: rgba(29, 78, 216, 0.35);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pair-card:not(.empty) {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .pair-card:not(.empty):active {
            transform: translateY(0);
        }
        .pair-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 0.5rem;
        }
        .pair-number {
            font-weight: 700;
            font-size: 1.05rem;
        }
        .pair-time {
            color: var(--muted);
            font-size: 0.9rem;
        }
        .pair-lessons {
            display: grid;
            gap: 0.75rem;
        }
        .lesson-detail {
            display: grid;
            gap: 0.35rem;
        }
        .lesson-subject {
            font-weight: 600;
            font-size: 1.05rem;
        }
        .lesson-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.45rem 0.75rem;
            color: var(--muted);
            font-size: 0.92rem;
        }
        .lesson-notes {
            font-size: 0.85rem;
            color: var(--muted);
        }
        .pair-card.empty {
            background: var(--muted-bg);
            border-style: dashed;
            color: var(--muted);
        }
        :root[data-theme="dark"] .pair-card.empty {
            background: var(--muted-bg);
            border-style: dashed;
            color: var(--muted);
        }
        .pair-card.empty .pair-number {
            color: var(--muted);
        }
        
        /* Current pair highlighting */
        .pair-card.current-pair .pair-number {
            color: #dc2626 !important;
            font-weight: 800 !important;
            position: relative;
        }
        
        .pair-card.current-pair .pair-number::after {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #dc2626;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulseDot 1.5s ease-in-out infinite;
        }
        
        @keyframes pulseDot {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.3;
                transform: scale(1.2);
            }
        }
        
        /* Dark theme adjustments for current pair */
        :root[data-theme="dark"] .pair-card.current-pair .pair-number {
            color: #ef4444 !important;
        }
        
        :root[data-theme="dark"] .pair-card.current-pair .pair-number::after {
            background-color: #ef4444;
        }
        .empty-text {
            font-style: italic;
            color: var(--muted);
        }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            background: rgba(29, 78, 216, 0.12);
            color: var(--accent-dark);
            font-weight: 600;
            font-size: 0.85rem;
        }
        :root[data-theme="dark"] .badge {
            background: rgba(59, 130, 246, 0.35);
            color: #dbeafe;
        }
        .badge-lecture {
            background: #eafc72;
            color: #3a3a00;
        }
        .badge-seminar {
            background: #009EED;
            color: #00263a;
        }
        :root[data-theme="dark"] .badge-lecture {
            background: rgba(234, 252, 114, 0.3);
            color: #eafc72;
        }
        :root[data-theme="dark"] .badge-seminar {
            background: rgba(0, 158, 237, 0.3);
            color: #009EED;
        }
        .load-more-wrapper {
            margin: 0.75rem 0 1.25rem;
            display: flex;
            justify-content: center;
        }
        .load-more {
            padding: 0.85rem 1.85rem;
            border-radius: 999px;
            border: none;
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 24px 38px -28px rgba(29, 78, 216, 0.8);
            transition: opacity 0.2s ease;
            opacity: 0;
        }
        .load-more.visible {
            opacity: 1;
        }
        .load-more.hidden {
            display: none;
        }
        .load-more:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        
        
        
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .placeholder-card {
            background: var(--card);
            border: 1px dashed var(--border);
            border-radius: 18px;
            padding: 2.5rem 1.75rem;
            text-align: center;
            color: var(--muted);
        }
        .placeholder-card h2 {
            margin: 0 0 0.75rem;
            font-size: 1.35rem;
            color: var(--text);
        }
        .placeholder-card p {
            margin: 0;
        }

        /* Стили для поиска новостей в заголовке */
        .news-search-header {
            position: absolute;
            right: 1rem;
            bottom: 1.8rem;
            display: flex;
            align-items: center;
            z-index: 10;
        }

        .news-search-toggle {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .news-search-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .news-search-toggle:active {
            transform: translateY(0);
        }

        .news-search-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 300px;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .news-search-box {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
        }

        .news-search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .news-search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.1);
        }

        .news-search-btn {
            padding: 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            transition: all 0.2s ease;
        }

        .news-search-btn:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        .news-search-btn:active {
            transform: translateY(0);
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .news-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .news-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -8px rgba(29, 78, 216, 0.3);
        }

        .news-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .news-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            line-height: 1.4;
            flex: 1;
        }

        .news-card-image {
            width: 120px;
            height: 81px; /* 120 * (691/1024) ≈ 81px для соотношения 1024:691 */
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
            aspect-ratio: 1024 / 691; /* Принудительно устанавливаем соотношение */
            background-color: var(--muted-bg);
        }

        /* Контейнер для изображения с правильным соотношением сторон */
        .news-image-container {
            position: relative;
            width: 120px;
            height: 81px;
            border-radius: 12px;
            overflow: hidden;
            background-color: var(--muted-bg);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .news-image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .news-image-placeholder {
            color: var(--muted);
            font-size: 0.75rem;
            text-align: center;
            padding: 0.5rem;
            line-height: 1.2;
        }

        .news-image-container.loading {
            background: linear-gradient(90deg, var(--muted-bg) 25%, var(--border) 50%, var(--muted-bg) 75%);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .news-card-excerpt {
            color: var(--muted);
            margin: 0 0 1rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--muted);
            gap: 1rem;
        }

        .news-meta-date {
            font-weight: 500;
        }

        .news-meta-author {
            opacity: 0.8;
        }

        .news-category {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .load-more-btn {
            width: 100%;
            padding: 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 18px;
            color: var(--text);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 1rem;
        }

        .load-more-btn:hover {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin: 0 0 0.5rem;
            color: var(--text);
        }

        .empty-state p {
            margin: 0;
        }

        .error-state {
            text-align: center;
            padding: 2rem;
            color: var(--muted);
        }

        .error-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .error-state h3 {
            margin: 0 0 0.5rem;
            color: var(--text);
        }

        .error-state p {
            margin: 0;
        }

        /* Модальное окно для детального просмотра новости */
        .news-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            padding-top: calc(1rem + var(--safe-area-top) + var(--tg-controls-height));
            backdrop-filter: blur(4px);
        }

        .news-modal-content {
            background: var(--card);
            border-radius: 18px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        .news-modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background: var(--muted-bg);
            color: var(--text);
        }

        .news-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .news-detail-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: var(--muted);
            flex-wrap: wrap;
        }

        .news-detail-images {
            margin-bottom: 1.5rem;
        }

        .news-detail-images img {
            width: 100%;
            height: auto;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            object-fit: contain; /* Сохраняем оригинальное соотношение сторон */
        }

        .news-detail-text {
            line-height: 1.6;
            color: var(--text);
        }

        .news-detail-text img {
            width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 1rem 0;
            object-fit: contain; /* Сохраняем оригинальное соотношение сторон */
        }

        .article-image {
            margin: 1rem 0;
            text-align: center;
        }

        .article-image img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .news-detail-text h1,
        .news-detail-text h2,
        .news-detail-text h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        #news-detail-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 1rem;
            color: var(--text);
            line-height: 1.3;
        }

        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .news-modal {
                padding: 0.5rem;
                padding-top: calc(0.5rem + var(--safe-area-top) + var(--tg-controls-height));
            }

            .news-modal-content {
                max-height: 95vh;
            }

            .news-card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .news-card-image,
            .news-image-container {
                width: 100%;
                height: 0;
                padding-bottom: 67.48%; /* (691/1024) * 100% = 67.48% для соотношения 1024:691 */
                position: relative;
                order: -1;
                margin-bottom: 1rem;
            }

            .news-image-container {
                background-color: var(--muted-bg);
            }

            .news-image-container img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                object-position: center;
            }

            .search-box {
                flex-direction: column;
            }

            .search-btn {
                width: 100%;
            }
        }
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
            background: rgba(2, 6, 23, 0.12);
            z-index: 9999;
        }
        .loading-overlay.visible { display: flex; }
        .spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(59, 130, 246, 0.25);
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            box-shadow: 0 18px 38px -18px rgba(29, 78, 216, 0.55);
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tabbar {
            position: sticky;
            bottom: 0;
            z-index: 10;
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            padding: 0.75rem 1rem calc(0.75rem + var(--safe-area-bottom));
            background: var(--tabbar-bg);
            backdrop-filter: blur(18px);
            border-top: 1px solid var(--tabbar-border);
            box-shadow: var(--tabbar-shadow);
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
        }
        .tab-item {
            flex: 1;
            border-radius: 16px;
            border: 1px solid var(--tab-item-border);
            background: var(--tab-item-bg);
            color: var(--tab-item-color);
            font-weight: 600;
            padding: 0.65rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            transform: translateY(0);
        }
        .tab-item--primary {
            flex: 0 0 auto;
            min-width: 140px;
            border-radius: 999px;
            background: var(--tab-item-primary-bg);
            color: var(--tab-item-primary-color);
            border: 1px solid var(--tab-item-border);
        }
        .tab-item--primary.active {
            color: var(--tab-item-primary-active-color);
            border-color: var(--tab-item-active-border);
            background: var(--tab-item-primary-active-bg);
            box-shadow: var(--tab-item-primary-active-shadow);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        .tab-item:hover {
            border-color: var(--tab-item-hover-border);
        }
        .tab-item--primary:hover {
            border-color: var(--tab-item-hover-border);
        }
        .tab-item.active {
            color: var(--text);
            border-color: var(--tab-item-active-border);
            background: var(--tab-item-active-bg);
            box-shadow: var(--tab-item-active-shadow);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        .tab-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(29, 78, 216, 0.1), rgba(59, 130, 246, 0.05));
            border-radius: inherit;
            z-index: -1;
        }
        :root[data-theme="dark"] .tab-item.active::before {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(59, 130, 246, 0.08));
        }
        .tab-item:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        .tab-item__label {
            pointer-events: none;
            color: inherit;
        }
        .tab-item__icon {
            height: 24px;
            width: auto;
            object-fit: contain;
            pointer-events: none;
            display: block;
            margin: 0 auto;
            transition: all 0.2s ease;
            filter: grayscale(100%) brightness(0.7);
        }
        .tab-item.active .tab-item__icon {
            filter: grayscale(0%) brightness(1);
        }
        .tab-item:hover .tab-item__icon {
            filter: grayscale(50%) brightness(0.85);
            transform: scale(1.05);
        }
        .tab-item.active:hover .tab-item__icon {
            filter: grayscale(0%) brightness(1.1);
        }
        @media (max-width: 480px) {
            .tab-item__icon {
                height: 20px;
            }
        }
        @media (min-width: 860px) {
            .tab-item__icon {
                height: 28px;
            }
        }
        @media (min-width: 860px) {
            .filters {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
            .field.dates {
                grid-column: span 2;
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 1rem;
            }
            .field.theme {
                grid-column: span 2;
            }
            .actions {
                grid-column: span 2;
                justify-content: flex-end;
            }
        }
        @media (max-width: 659px) {
            .panel {
                padding: 1rem 1.1rem 1.2rem;
            }
            .day-block {
                padding: 1rem 1.1rem 1.2rem;
            }
            .settings-container {
                padding: 0.5rem;
                gap: 1rem;
            }
            .setting-item {
                padding: 0.75rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .setting-info {
                width: 100%;
            }
            .section-title {
                font-size: 1.1rem;
            }
            .pair-card {
                padding: 0.85rem 0.95rem;
            }
            #weekly-date-selector {
                padding: 0.8rem 1rem 1rem;
                margin-bottom: 1.25rem;
            }
            .pair-number {
                font-size: 1rem;
            }
            .lesson-subject {
                font-size: 1rem;
            }
            .toggle-switch {
                width: 52px;
                height: 28px;
            }
            .toggle-slider:before {
                height: 20px;
                width: 20px;
                left: 3px;
                bottom: 3px;
            }
            .toggle-switch input:checked + .toggle-slider:before {
                transform: translateX(24px);
            }
        }
        /* Weekly date selector: separate panel */
        #weekly-panel {
            width: 100%;
        }
        #weekly-date-selector {
            display: grid !important;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.4rem;
            width: 100%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--card);
            border-radius: 18px;
            box-shadow: 0 22px 55px -30px rgba(15, 23, 42, 0.4);
            padding: 1rem 1.2rem 1.2rem;
            margin-bottom: 1.5rem;
        }
        
        /* Day labels container */
        .day-label-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
        }
        
        /* Day labels */
        .day-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.15rem;
        }
        #weekly-date-selector .tab-item {
            width: 100%;
            aspect-ratio: 1 / 1;
            padding: 0;
            border-radius: 12px;
            font-size: clamp(1rem, 2.2vw, 1.25rem);
            transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Today highlight - simple glow effect */
        #weekly-date-selector .tab-item.today {
            box-shadow: 0 0 8px rgba(29, 78, 216, 0.3) !important;
        }
        
        #weekly-date-selector .tab-item.today.active {
            box-shadow: 0 0 15px rgba(29, 78, 216, 0.5), 0 8px 25px -8px rgba(29, 78, 216, 0.4), 0 0 0 1px rgba(29, 78, 216, 0.3) !important;
            transform: translateY(-2px);
        }
        
        :root[data-theme="dark"] #weekly-date-selector .tab-item.today {
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.4) !important;
        }
        
        :root[data-theme="dark"] #weekly-date-selector .tab-item.today.active {
            box-shadow: 0 0 18px rgba(96, 165, 250, 0.6), 0 8px 25px -8px rgba(37, 99, 235, 0.5), 0 0 0 1px rgba(96, 165, 250, 0.4) !important;
            transform: translateY(-2px);
        }
        @media (min-width: 860px) {
            #weekly-date-selector .tab-item {
                font-size: 1.15rem;
            }
            .day-label {
                font-size: 0.8rem;
            }
        }
        
        /* Week navigation styles */
        .week-navigation {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
            position: absolute;
            bottom: 1.8rem;
            right: 1rem;
            z-index: 10;
        }
        
        .week-nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2), 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .week-nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1;
            pointer-events: none;
        }
        
        .week-nav-btn:hover:not(:active) {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .week-nav-btn:hover:not(:active)::before {
            opacity: 1;
        }
        
        .week-nav-btn:active {
            transform: scale(0.95) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            background: rgba(255, 255, 255, 0.3) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.6) !important;
        }
        
        .week-nav-btn:focus {
            outline: none;
        }
        
        .week-nav-btn:focus:not(:active):not(:hover) {
            transform: scale(1.02);
        }
        
        /* Ensure buttons return to normal state after interaction */
        .week-nav-btn:not(:hover):not(:active):not(:focus) {
            transform: scale(1);
        }
        
        .week-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .week-nav-btn:disabled:hover {
            transform: none !important;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color, rgba(0, 0, 0, 0.1));
        }
        
        .week-nav-btn svg {
            position: relative;
            z-index: 2;
            width: 22px;
            height: 22px;
            pointer-events: none;
            transition: none;
        }
        
        /* Dark theme adjustments */
        :root[data-theme="dark"] .week-nav-btn {
            background: var(--bg-secondary);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4), 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        :root[data-theme="dark"] .week-nav-btn:hover:not(:active) {
            background: var(--accent-color);
            border-color: var(--accent-color);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5), 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        :root[data-theme="dark"] .week-nav-btn:active {
            background: var(--accent-color) !important;
            border-color: var(--accent-color) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
        }
        
        :root[data-theme="dark"] .week-nav-btn::before {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
        }
        
        /* Mobile adjustments */
        @media (max-width: 480px) {
            .week-navigation {
                bottom: 1.5rem;
                right: 0.75rem;
            }
            
            .week-nav-btn {
                width: 40px;
                height: 40px;
            }
            
            .week-nav-btn svg {
                width: 18px;
                height: 18px;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 360px) {
            .week-navigation {
                bottom: 1.2rem;
                right: 0.5rem;
            }
            
            .week-nav-btn {
                width: 36px;
                height: 36px;
            }
            
            .week-nav-btn svg {
                width: 16px;
                height: 16px;
            }
        }
        
        /* Swipe animation classes for individual date buttons */
        /* Swipe left: wave goes from left to right (1→6) */
        #weekly-date-selector.swipe-left .day-label-container:nth-child(1) .tab-item {
            animation: swipeLeft 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0s;
        }
        #weekly-date-selector.swipe-left .day-label-container:nth-child(2) .tab-item {
            animation: swipeLeft 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.03s;
        }
        #weekly-date-selector.swipe-left .day-label-container:nth-child(3) .tab-item {
            animation: swipeLeft 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.06s;
        }
        #weekly-date-selector.swipe-left .day-label-container:nth-child(4) .tab-item {
            animation: swipeLeft 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.09s;
        }
        #weekly-date-selector.swipe-left .day-label-container:nth-child(5) .tab-item {
            animation: swipeLeft 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.12s;
        }
        #weekly-date-selector.swipe-left .day-label-container:nth-child(6) .tab-item {
            animation: swipeLeft 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.15s;
        }
        
        /* Swipe right: wave goes from right to left (6→1) */
        #weekly-date-selector.swipe-right .day-label-container:nth-child(1) .tab-item {
            animation: swipeRight 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.15s;
        }
        #weekly-date-selector.swipe-right .day-label-container:nth-child(2) .tab-item {
            animation: swipeRight 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.12s;
        }
        #weekly-date-selector.swipe-right .day-label-container:nth-child(3) .tab-item {
            animation: swipeRight 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.09s;
        }
        #weekly-date-selector.swipe-right .day-label-container:nth-child(4) .tab-item {
            animation: swipeRight 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.06s;
        }
        #weekly-date-selector.swipe-right .day-label-container:nth-child(5) .tab-item {
            animation: swipeRight 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.03s;
        }
        #weekly-date-selector.swipe-right .day-label-container:nth-child(6) .tab-item {
            animation: swipeRight 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0s;
        }
        
        @keyframes swipeLeft {
            0% { transform: translateX(0) scale(1); opacity: 1; }
            50% { transform: translateX(-15px) scale(0.95); opacity: 0.8; }
            100% { transform: translateX(0) scale(1); opacity: 1; }
        }
        
        @keyframes swipeRight {
            0% { transform: translateX(0) scale(1); opacity: 1; }
            50% { transform: translateX(15px) scale(0.95); opacity: 0.8; }
            100% { transform: translateX(0) scale(1); opacity: 1; }
        }
        
        /* Weekly schedule block: separate panel */
        #weekly-schedule-block {
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        #weekly-schedule-block.loading {
            opacity: 0.7;
        }
        #weekly-schedule-block.day-changing {
            opacity: 0.4;
            transform: translateY(8px);
        }
        #weekly-schedule-block.day-changed {
            opacity: 1;
            transform: translateY(0);
        }
        /* Modal для карточки пары */
        .pair-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .pair-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .pair-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .pair-modal-content {
            position: relative;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
            opacity: 1;
            z-index: 1001;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .pair-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .pair-type-badge {
            background: var(--accent);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pair-time {
            position: absolute;
            top: 20px;
            right: 60px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .pair-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .pair-modal-close:hover {
            background: var(--muted-bg);
            color: var(--text);
        }

        .pair-modal-body {
            padding: 20px 24px 24px;
        }

        .pair-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin: 0 0 12px 0;
            line-height: 1.3;
        }

        .pair-teacher {
            font-size: 16px;
            color: var(--muted);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .pair-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pair-room {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--muted);
        }

        .pair-notes {
            font-size: 14px;
            color: var(--muted);
            line-height: 1.5;
            background: var(--muted-bg);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }

        /* Темная тема для модального окна */
        :root[data-theme="dark"] .pair-modal-content {
            background: var(--card);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        :root[data-theme="dark"] .pair-modal-header {
            border-bottom-color: var(--border);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .pair-modal {
                padding: 10px;
            }
            
            .pair-modal-content {
                max-height: 90vh;
            }
            
            .pair-modal-header {
                padding: 16px 20px 12px;
            }
            
            .pair-time {
                position: static;
                font-size: 16px;
            }
            
            .pair-modal-body {
                padding: 16px 20px 20px;
            }
            
            .pair-title {
                font-size: 20px;
            }
        }

        /* Стили для типов пар */
        .pair-type-badge.lecture {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .pair-type-badge.seminar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .pair-type-badge.practical {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .pair-type-badge.lab {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .pair-type-badge.other {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        /* === СТИЛИ ДЛЯ СИСТЕМЫ УВЕДОМЛЕНИЙ === */
        
        /* Notifications Modal */
        .notifications-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }

        .notifications-modal.show {
            display: block;
        }

        .notifications-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .notifications-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .notifications-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--background);
            border-radius: 16px 16px 0 0;
        }

        .notifications-modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .notifications-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .notifications-modal-close:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .notifications-modal-body {
            padding: 1.5rem;
        }

        .notification-setting-group {
            margin-bottom: 2rem;
        }

        .notification-setting-group h4 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .setting-item:hover {
            background: var(--surface-hover);
        }

        .setting-label {
            color: var(--text-primary);
            font-size: 0.9rem;
            flex: 1;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background-color: var(--accent);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Quiet Hours Setting */
        .quiet-hours-setting {
            background: var(--surface);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .time-input-group label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-width: 2rem;
        }

        .time-input-group input[type="time"] {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .quiet-hours-help {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Notifications History */
        .notifications-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
        }

        .notification-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background: var(--surface-hover);
        }

        .notification-item.unread {
            background: rgba(var(--accent-rgb), 0.1);
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .notification-message {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .notification-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 0.25rem;
        }

        .notification-status.sent {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .notification-status.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        /* Actions */
        .notifications-modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .notifications-modal-actions button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        /* Send Notification Modal */
        .send-notification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }

        .send-notification-modal.show {
            display: block;
        }

        .send-notification-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .send-notification-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .send-notification-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--background);
            border-radius: 16px 16px 0 0;
        }

        .send-notification-modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .send-notification-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-notification-modal-close:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .send-notification-modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
  }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Loading states */
        .loading-text {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 1rem;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .notifications-modal-content,
            .send-notification-modal-content {
                width: 95%;
                max-height: 85vh;
            }

            .notification-setting-group {
                margin-bottom: 1.5rem;
            }

            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .notifications-modal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
    <body>
        <!-- Welcome Modal -->
        <div id="welcome-modal" class="welcome-modal" style="display: none;">
            <div class="welcome-modal__overlay"></div>
            <div class="welcome-modal__content">
                <div class="welcome-modal__header">
                    <h2 class="welcome-modal__title">Привет!</h2>
                    <p class="welcome-modal__subtitle">Выбери расписание для начала работы</p>
                </div>
                
                <div class="welcome-modal__body">
                    <div class="welcome-modal__steps">
                        <div class="welcome-step active" data-step="1">
                            <div class="welcome-step__number">1</div>
                            <div class="welcome-step__content">
                                <h3>Выберите факультет</h3>
                                <p>Начните с выбора вашего факультета</p>
                            </div>
                        </div>
                        
                        <div class="welcome-step" data-step="2">
                            <div class="welcome-step__number">2</div>
                            <div class="welcome-step__content">
                                <h3>Выберите курс</h3>
                                <p>Укажите ваш курс обучения</p>
                            </div>
                        </div>
                        
                        <div class="welcome-step" data-step="3">
                            <div class="welcome-step__number">3</div>
                            <div class="welcome-step__content">
                                <h3>Выберите группу</h3>
                                <p>Выберите вашу учебную группу</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="welcome-modal__form">
                        <div class="field">
                            <label for="welcome-faculty">Факультет</label>
                            <select id="welcome-faculty" aria-label="Выбор факультета">
                                <option value="">Выберите факультет</option>
                            </select>
                        </div>
                        
                        <div class="field">
                            <label for="welcome-course">Курс</label>
                            <select id="welcome-course" aria-label="Выбор курса" disabled>
                                <option value="">Сначала выберите факультет</option>
                            </select>
                        </div>
                        
                        <div class="field">
                            <label for="welcome-group">Группа</label>
                            <select id="welcome-group" aria-label="Выбор группы" disabled>
                                <option value="">Сначала выберите курс</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="welcome-modal__footer">
                    <button id="welcome-skip" class="welcome-btn welcome-btn--secondary">Пропустить</button>
                    <button id="welcome-continue" class="welcome-btn welcome-btn--primary" disabled>Продолжить</button>
                </div>
            </div>
        </div>

        <div class="app-shell">
    <header class="app-header">
        <div class="app-header__content">
            <div class="app-header__main">
                <h1 class="app-header__title">Расписание</h1>
                <p class="lead app-header__subtitle hidden"></p>
            </div>
            
            <!-- Кнопка поиска для новостей -->
            <div id="news-search-header" class="news-search-header" style="display: none;">
                <button type="button" id="news-search-toggle" class="news-search-toggle" aria-label="Поиск новостей">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
                
                <!-- Раскрывающееся поле поиска -->
                <div id="news-search-dropdown" class="news-search-dropdown" style="display: none;">
                    <div class="news-search-box">
                        <input type="text" id="news-search-input" placeholder="Поиск новостей..." class="news-search-input">
                        <button type="button" id="news-search-btn" class="news-search-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Week navigation arrows -->
        <div id="week-navigation" class="week-navigation">
            <button id="prev-week-btn" class="week-nav-btn" aria-label="Предыдущая неделя">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15,18 9,12 15,6"></polyline>
                </svg>
            </button>
            <button id="next-week-btn" class="week-nav-btn" aria-label="Следующая неделя">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
            </button>
        </div>
    </header>
    <main>
        <section class="tab-content" data-tab="news" role="tabpanel" aria-labelledby="tab-news" id="panel-news">
            <!-- Загрузка -->
            <div id="news-loading" class="loading-container" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Загружаем новости...</p>
            </div>

            <!-- Список новостей -->
            <div id="news-list" class="news-list">
                <!-- Новости будут загружены динамически -->
            </div>

            <!-- Кнопка "Загрузить ещё" -->
            <div class="news-load-more-container" style="display: none;">
                <button type="button" id="news-load-more-btn" class="load-more-btn">
                    Загрузить ещё
                </button>
            </div>

            <!-- Сообщение об отсутствии новостей -->
            <div id="news-empty" class="empty-state" style="display: none;">
                <div class="empty-icon">📰</div>
                <h3>Новостей пока нет</h3>
                <p>Попробуйте обновить страницу или зайти позже</p>
            </div>

            <!-- Модальное окно детального просмотра новости -->
            <div id="news-detail-modal" class="news-modal" style="display: none;">
                <div class="news-modal-content">
                    <div class="news-modal-header">
                        <button type="button" id="news-modal-close" class="modal-close-btn">×</button>
                    </div>
                    <div class="news-modal-body">
                        <div id="news-detail-loading" class="loading-container">
                            <div class="loading-spinner"></div>
                            <p>Загружаем статью...</p>
                        </div>
                        <div id="news-detail-content" style="display: none;">
                            <h1 id="news-detail-title"></h1>
                            <div class="news-detail-meta">
                                <span id="news-detail-date" class="news-meta-date"></span>
                                <span id="news-detail-author" class="news-meta-author"></span>
                            </div>
                            <div id="news-detail-images" class="news-detail-images"></div>
                            <div id="news-detail-text" class="news-detail-text"></div>
                        </div>
                        <div id="news-detail-error" class="error-state" style="display: none;">
                            <div class="error-icon">⚠️</div>
                            <h3>Ошибка загрузки</h3>
                            <p>Не удалось загрузить статью. Попробуйте позже.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="tab-content tab-content--schedule active" data-tab="schedule" role="tabpanel" aria-labelledby="tab-schedule" id="panel-schedule">
            
            
            <section id="weekly-panel" style="position: relative;">
                <div id="loading-overlay-weekly" class="loading-overlay" aria-hidden="true" aria-live="polite" aria-label="Загрузка">
                    <div class="spinner" role="status"></div>
                </div>
                
                <div id="weekly-date-selector" style="display: flex; gap: 0.5rem; justify-content: center;"></div>
                <div id="weekly-schedule-block"></div>
            </section>
            
        </section>


        <section class="tab-content" data-tab="settings" role="tabpanel" aria-labelledby="tab-settings" id="panel-settings">
            <div class="settings-container">
                <!-- Основные настройки -->
                <section class="settings-section">
                    <div class="section-header">
                        <h3 class="section-title">Основные настройки</h3>
                    </div>
                    <div class="panel">
                        <div class="filters">
                            <div class="field">
                                <label for="faculty">
                                    Факультет
                                </label>
                                <select id="faculty" aria-label="Выбор факультета">
                                    <option value="">Выберите факультет</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="course">
                                    Курс
                                </label>
                                <select id="course" aria-label="Выбор курса" disabled>
                                    <option value="">Сначала выберите факультет</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="group">
                                    Группа
                                </label>
                                <select id="group" aria-label="Выбор группы" disabled>
                                    <option value="">Сначала выберите курс</option>
                                </select>
                            </div>
                            <div class="field dates hidden">
                                <div>
                                    <label for="from">
                                        Дата с
                                    </label>
                                    <input id="from" type="date">
                                </div>
                                <div>
                                    <label for="to">
                                        Дата по
                                    </label>
                                    <input id="to" type="date">
                                </div>
                            </div>
                            <div class="actions">
                                <button id="load" type="button" class="primary" disabled>
                                    Показать расписание
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Настройки интерфейса -->
                <section class="settings-section">
                    <div class="section-header">
                        <h3 class="section-title">Интерфейс</h3>
                    </div>
                    <div class="panel">
                        <div class="filters">
                            <div class="field">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span>Следовать системной теме</span>
                                    <label class="toggle-switch modern">
                                        <input type="checkbox" id="follow-system-theme">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="field">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span>Темная тема</span>
                                    <label class="toggle-switch modern">
                                        <input type="checkbox" id="theme-toggle" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="field">
                                <label for="font-size">
                                    Размер шрифта
                                </label>
                                <select id="font-size" class="setting-select">
                                    <option value="small">Мелкий</option>
                                    <option value="medium" selected>Средний</option>
                                    <option value="large">Крупный</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Информация о пользователе -->
                <section class="settings-section">
                    <div class="section-header">
                        <h3 class="section-title">Пользователь</h3>
                    </div>
                    <div class="panel">
                        <div id="user-info" class="user-info-settings" style="display: none;">
                            <!-- Информация о пользователе будет добавлена через JavaScript -->
                        </div>
                        
                        
                        <div id="user-management-panel" class="user-management-panel-settings" style="display: none;">
                            <button id="manage-users-btn" class="manage-users-btn-settings">Управление пользователями</button>
                        </div>
                        <div id="user-actions" class="user-actions-settings" style="display: none;">
                            <button id="logout-btn" class="logout-btn-settings">Выйти из аккаунта</button>
                        </div>
                        
                        <!-- Панель администратора -->
                        <div id="admin-panel" class="admin-panel-settings" style="display: none;">
                            <h4>Панель администратора</h4>
                            <button id="manage-all-groups-btn" class="admin-btn-settings">Управление всеми группами</button>
                            <button id="assign-monitor-btn" class="admin-btn-settings">Назначить старосту</button>
                        </div>
                        
                        <!-- Раздел уведомлений -->
                        <div id="notifications-section" class="notifications-section-settings" style="display: block;">
                            <h4>Уведомления</h4>
                            <div class="settings-panel">
                                <!-- Кнопка уведомлений будет добавлена через JavaScript -->
                            </div>
                        </div>
                    </div>
                </section>

            </div>
            <div id="status" class="status" role="status"></div>
        </section>
    </main>
    <nav class="tabbar" role="tablist">
        <button type="button" class="tab-item" role="tab" id="tab-news" data-tab="news" aria-controls="panel-news" aria-selected="false" aria-label="Новости">
            <img src="/static/Лента.png" data-light="/static/Лента.png" data-dark="/static/Лента_тёмная_тема.png" alt="Новости" class="tab-item__icon">
        </button>
        <button type="button" class="tab-item tab-item--primary active" role="tab" id="tab-schedule" data-tab="schedule" aria-controls="panel-schedule" aria-selected="true" aria-label="Расписание">
            <img src="/static/Расписание.png" data-light="/static/Расписание.png" data-dark="/static/Расписание_тёмная_тема.png" alt="Расписание" class="tab-item__icon">
        </button>
        <button type="button" class="tab-item" role="tab" id="tab-settings" data-tab="settings" aria-controls="panel-settings" aria-selected="false" aria-label="Настройки">
            <img src="/static/Настройки.png" data-light="/static/Настройки.png" data-dark="/static/Настройки_тёмная_тема.png" alt="Настройки" class="tab-item__icon">
        </button>
    </nav>


    </div>
    <script>
        // --- Weekly View (inside Schedule) ---
        const weeklyPanel = document.getElementById('weekly-panel');
        const weeklyDateSelector = document.getElementById('weekly-date-selector');
        const weeklyScheduleBlock = document.getElementById('weekly-schedule-block');
        
        // --- Week Navigation ---
        const weekNavigation = document.getElementById('week-navigation');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');

        // --- Current Pair Highlighting ---
        
        // Function to get current Moscow time
        function getCurrentMoscowTime() {
            const now = new Date();
            // Get UTC time and add Moscow timezone offset (UTC+3)
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
            const moscowTime = new Date(utcTime + (3 * 60 * 60 * 1000));
            return moscowTime;
        }


        // Function to parse time string (HH:MM format)
        function parseTime(timeStr) {
            if (!timeStr) return null;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return { hours, minutes };
        }

        // Function to check if current time is within pair time range
        function isCurrentPair(pairLessons) {
            if (!pairLessons || pairLessons.length === 0) return false;
            
            const currentTime = getCurrentMoscowTime();
            const currentHours = currentTime.getHours();
            const currentMinutes = currentTime.getMinutes();
            
            // Get time from first lesson (assuming all lessons in pair have same time)
            const firstLesson = pairLessons[0];
            const startTime = parseTime(firstLesson.starts_at);
            const endTime = parseTime(firstLesson.ends_at);
            
            if (!startTime || !endTime) return false;
            
            // Convert to minutes for easier comparison
            const currentMinutesTotal = currentHours * 60 + currentMinutes;
            const startMinutesTotal = startTime.hours * 60 + startTime.minutes;
            const endMinutesTotal = endTime.hours * 60 + endTime.minutes;
            
            return currentMinutesTotal >= startMinutesTotal && currentMinutesTotal <= endMinutesTotal;
        }

        // Function to check if pair is for today
        function isTodayPair(pairLessons) {
            if (!pairLessons || pairLessons.length === 0) return false;
            
            const today = getCurrentMoscowTime();
            const todayStr = formatAPIDate(today);
            
            return pairLessons.some(lesson => {
                const lessonDate = lesson.date;
                if (!lessonDate) return false;
                
                // Handle both yyyy-mm-dd and dd.mm.yyyy formats
                if (lessonDate.includes('-')) {
                    return lessonDate === todayStr;
                } else {
                    const [day, month, year] = lessonDate.split('.');
                    const formatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    return formatted === todayStr;
                }
            });
        }

        // Function to update current pair highlighting
        function updateCurrentPairHighlighting() {
            if (!weeklyScheduleBlock) return;
            
            const pairCards = weeklyScheduleBlock.querySelectorAll('.pair-card');
            pairCards.forEach(card => {
                card.classList.remove('current-pair');
            });
            
            // Only highlight if we're viewing today's schedule
            const today = getCurrentMoscowTime();
            const todayStr = formatAPIDate(today);
            
            if (currentlySelectedDate === todayStr) {
                const pairCards = weeklyScheduleBlock.querySelectorAll('.pair-card');
                pairCards.forEach(card => {
                    const pairNumber = card.querySelector('.pair-number');
                    if (pairNumber) {
                        const pairText = pairNumber.textContent;
                        const pairMatch = pairText.match(/(\d+)\s*пара/);
                        if (pairMatch) {
                            const pairNum = parseInt(pairMatch[1]);
                            
                            // Find lessons for this pair
                            const lessons = aggregatedLessons.filter(l => {
                                const lessonDate = l.date;
                                if (!lessonDate) return false;
                                
                                let formattedDate;
                                if (lessonDate.includes('-')) {
                                    formattedDate = lessonDate;
                                } else {
                                    const [day, month, year] = lessonDate.split('.');
                                    formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                }
                                
                                return formattedDate === todayStr && l.pair_number === pairNum;
                            });
                            
                            if (isCurrentPair(lessons)) {
                                card.classList.add('current-pair');
                            }
                        }
                    }
                });
            }
        }

        // Auto-update current pair highlighting every minute
        let currentPairUpdateInterval = null;
        
        function startCurrentPairUpdates() {
            // Clear existing interval
            if (currentPairUpdateInterval) {
                clearInterval(currentPairUpdateInterval);
            }
            
            // Update immediately
            updateCurrentPairHighlighting();
            
            // Update every minute
            currentPairUpdateInterval = setInterval(updateCurrentPairHighlighting, 60000);
        }
        
        function stopCurrentPairUpdates() {
            if (currentPairUpdateInterval) {
                clearInterval(currentPairUpdateInterval);
                currentPairUpdateInterval = null;
            }
        }

        // Helper: get Monday of current week
        function getMonday(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return getMonday(new Date()); // Fallback to current date
            }
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const result = new Date(d);
            result.setDate(diff);
            return result;
        }

        // Global state: synchronized week across both feed and weekly modes
        let currentWeekMonday = getMonday(new Date());
        
        // Track currently selected date to preserve user choice
        let currentlySelectedDate = null;

        // Helper: format date for display in weekly selector (e.g., 25)
        function formatShortDate(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return '?';
            }
            const d = new Date(date);
            const day = d.getDate();
            return `${day}`;
        }

        // Helper: format date for API (yyyy-mm-dd)
        function formatAPIDate(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return '1970-01-01'; // Fallback date
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Helper function to update today highlighting
        function updateTodayHighlighting() {
            if (!weeklyDateSelector) return;
            
            const todayStr = formatAPIDate(new Date());
            const buttons = Array.from(weeklyDateSelector.querySelectorAll('button'));
            
            buttons.forEach(btn => {
                if (btn.dataset.date === todayStr) {
                    btn.classList.add('today');
                } else {
                    btn.classList.remove('today');
                }
            });
        }

        // Render horizontal selector for a week based on currentWeekMonday (Mon-Sat)
        function renderWeeklyDateSelector(preserveSelection = false) {
            if (!weeklyDateSelector) return;
            
            weeklyDateSelector.innerHTML = '';
            
            // Validate currentWeekMonday
            if (!currentWeekMonday || !(currentWeekMonday instanceof Date) || isNaN(currentWeekMonday.getTime())) {
                currentWeekMonday = getMonday(new Date());
            }
            
            const monday = new Date(currentWeekMonday);
            
            const todayStr = formatAPIDate(new Date());
            
            // Day names in Russian
            const dayNames = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ'];
            
            for (let i = 0; i < 6; i++) { // Понедельник-суббота
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                
                // Validate the calculated date
                if (isNaN(d.getTime())) {
                    console.warn(`Invalid date calculated for day ${i} of week starting ${monday}`);
                    continue;
                }
                
                // Create container for button and label
                const container = document.createElement('div');
                container.className = 'day-label-container';
                
                const btn = document.createElement('button');
                btn.className = 'tab-item';
                btn.textContent = formatShortDate(d);
                btn.dataset.date = formatAPIDate(d);
                btn.type = 'button';
                btn.onclick = () => selectWeeklyDate(btn.dataset.date, btn);
                
                // Add 'today' class if this is today's date
                if (btn.dataset.date === todayStr) {
                    btn.classList.add('today');
                }
                
                // Create day label
                const label = document.createElement('div');
                label.className = 'day-label';
                label.textContent = dayNames[i];
                
                container.appendChild(btn);
                container.appendChild(label);
                weeklyDateSelector.appendChild(container);
            }
            
            // Preserve user selection or select appropriate default
            if (preserveSelection && currentlySelectedDate) {
                const selectedBtn = Array.from(weeklyDateSelector.querySelectorAll('button'))
                    .find(b => b.dataset.date === currentlySelectedDate);
                if (selectedBtn) {
                    selectWeeklyDate(selectedBtn.dataset.date, selectedBtn);
                    return;
                } else {
                    // If the selected date is not in current week, clear the selection
                    currentlySelectedDate = null;
                }
            }
            
            // Only auto-select if no date is currently selected
            if (!currentlySelectedDate) {
                const firstBtn = weeklyDateSelector.querySelector('button');
                if (firstBtn) {
                    selectWeeklyDate(firstBtn.dataset.date, firstBtn);
                }
            }
            
            // Always update today highlighting after rendering
            updateTodayHighlighting();
        }


        // Navigate to previous week
        function goToPreviousWeek() {
            if (!currentWeekMonday) return;
            
            // Calculate relative day position in current week
            let relativeDayIndex = 0;
            if (currentlySelectedDate) {
                const selectedDate = parseInputDate(currentlySelectedDate);
                const weekStart = new Date(currentWeekMonday);
                const dayDiff = Math.floor((selectedDate.getTime() - weekStart.getTime()) / (1000 * 60 * 60 * 24));
                relativeDayIndex = Math.max(0, Math.min(5, dayDiff));
            }
            
            // Go to previous week
            currentWeekMonday = addDays(currentWeekMonday, -7);
            
            // Add swipe animation
            if (weeklyDateSelector) {
                weeklyDateSelector.classList.add('swipe-right');
                setTimeout(() => {
                    weeklyDateSelector.classList.remove('swipe-right');
                }, 350);
            }
            
            // Try to select today's date in the new week, otherwise preserve relative position
            const todayStr = formatAPIDate(new Date());
            const newWeekStart = new Date(currentWeekMonday);
            const todayInNewWeek = new Date(newWeekStart);
            todayInNewWeek.setDate(newWeekStart.getDate() + relativeDayIndex);
            
            if (formatAPIDate(todayInNewWeek) === todayStr) {
                currentlySelectedDate = todayStr;
            } else {
                currentlySelectedDate = formatAPIDate(todayInNewWeek);
            }
            
            renderWeeklyDateSelector(true); // Preserve selection
            
            // Update today highlighting after swipe
            setTimeout(() => {
                updateTodayHighlighting();
            }, 50);
        }

        // Navigate to next week
        function goToNextWeek() {
            if (!currentWeekMonday) return;
            
            // Calculate relative day position in current week
            let relativeDayIndex = 0;
            if (currentlySelectedDate) {
                const selectedDate = parseInputDate(currentlySelectedDate);
                const weekStart = new Date(currentWeekMonday);
                const dayDiff = Math.floor((selectedDate.getTime() - weekStart.getTime()) / (1000 * 60 * 60 * 24));
                relativeDayIndex = Math.max(0, Math.min(5, dayDiff));
            }
            
            // Go to next week
            currentWeekMonday = addDays(currentWeekMonday, 7);
            
            // Add swipe animation
            if (weeklyDateSelector) {
                weeklyDateSelector.classList.add('swipe-left');
                setTimeout(() => {
                    weeklyDateSelector.classList.remove('swipe-left');
                }, 350);
            }
            
            // Try to select today's date in the new week, otherwise preserve relative position
            const todayStr = formatAPIDate(new Date());
            const newWeekStart = new Date(currentWeekMonday);
            const todayInNewWeek = new Date(newWeekStart);
            todayInNewWeek.setDate(newWeekStart.getDate() + relativeDayIndex);
            
            if (formatAPIDate(todayInNewWeek) === todayStr) {
                currentlySelectedDate = todayStr;
            } else {
                currentlySelectedDate = formatAPIDate(todayInNewWeek);
            }
            
            renderWeeklyDateSelector(true); // Preserve selection
            
            // Update today highlighting after swipe
            setTimeout(() => {
                updateTodayHighlighting();
            }, 50);
        }

        // Show schedule for selected date only
        function selectWeeklyDate(dateStr, btn) {
            // Remove active class from all buttons (including those in containers)
            Array.from(weeklyDateSelector.querySelectorAll('button')).forEach(b => b.classList.remove('active'));
            
            // Add active class to selected button with animation
            btn.classList.add('active');
            
            // Add selection animation
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => {
                btn.style.transform = '';
            }, 150);
            
            // Save user selection
            currentlySelectedDate = dateStr;
            
            // Update current pair highlighting immediately
            updateCurrentPairHighlighting();
            
            // Add soft day change animation
            if (weeklyScheduleBlock) {
                weeklyScheduleBlock.classList.remove('day-changed');
                weeklyScheduleBlock.classList.add('day-changing');
                
                // Small delay for smooth transition
                setTimeout(() => {
                    renderWeeklySchedule(dateStr);
                }, 50);
            } else {
                renderWeeklySchedule(dateStr);
            }
        }

        // Render schedule block for selected date
        function renderWeeklySchedule(dateStr) {
            // Add loading animation
            if (weeklyScheduleBlock) {
                weeklyScheduleBlock.classList.add('loading');
            }
            
            // Найти занятия для выбранной даты
            const lessons = aggregatedLessons.filter(l => {
                const lessonDate = l.date;
                if (!lessonDate) return false;
                // Accept both yyyy-mm-dd and dd.mm.yyyy
                if (lessonDate.includes('-')) return lessonDate === dateStr;
                const [day, month, year] = lessonDate.split('.');
                const formatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                return formatted === dateStr;
            });
            weeklyScheduleBlock.innerHTML = '';
            // day-header всегда соответствует выбранной дате
            let displayDate = dateStr;
            if (displayDate.includes('-')) {
                const [year, month, day] = displayDate.split('-');
                displayDate = `${day}.${month}.${year}`;
            }
            if (!lessons.length) {
                weeklyScheduleBlock.innerHTML = `<div class="placeholder-card">Нет занятий на выбранную дату.<br>${formatDateHuman(displayDate)}</div>`;
                // Remove loading animation and complete day change animation
                setTimeout(() => {
                    if (weeklyScheduleBlock) {
                        weeklyScheduleBlock.classList.remove('loading');
                        weeklyScheduleBlock.classList.remove('day-changing');
                        weeklyScheduleBlock.classList.add('day-changed');
                    }
                }, 50);
                return;
            }
            // Create day-block structure similar to schedule-days
            const dayBlock = document.createElement('section');
            dayBlock.className = 'day-block';
            
            const header = document.createElement('header');
            header.className = 'day-header';
            const heading = document.createElement('h2');
            heading.textContent = formatDateHuman(displayDate);
            header.appendChild(heading);
            dayBlock.appendChild(header);
            
            // Create pairs container
            const pairsContainer = document.createElement('div');
            pairsContainer.className = 'pair-list';
            const { pairMap, extras } = buildPairMap(lessons);
            if (pairMap.size) {
                const existingPairs = Array.from(pairMap.keys()).sort((a, b) => a - b);
                const maxPair = Math.max(...existingPairs);
                for (let pair = 1; pair <= maxPair; pair += 1) {
                    const pairLessons = pairMap.get(pair) || [];
                    const card = document.createElement('article');
                    card.className = 'pair-card';
                    
                    // Check if this is the current pair (today and current time)
                    if (isTodayPair(pairLessons) && isCurrentPair(pairLessons)) {
                        card.classList.add('current-pair');
                    }
                    
                    // Add click handler for pair card
                    if (pairLessons.length > 0) {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => openPairModal(pairLessons, pair));
                    }
                    
                    const headerEl = document.createElement('div');
                    headerEl.className = 'pair-header';
                    const numberSpan = document.createElement('span');
                    numberSpan.className = 'pair-number';
                    numberSpan.textContent = `${pair} пара`;
                    headerEl.appendChild(numberSpan);
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'pair-time';
                    timeSpan.textContent = pairLessons.length ? formatTimeRange(pairLessons[0].starts_at, pairLessons[0].ends_at) : '';
                    headerEl.appendChild(timeSpan);
                    card.appendChild(headerEl);
                    if (!pairLessons.length) {
                        card.classList.add('empty');
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'empty-text';
                        emptyDiv.textContent = 'Нет занятия';
                        card.appendChild(emptyDiv);
                    } else {
                        const lessonsWrapper = document.createElement('div');
                        lessonsWrapper.className = 'pair-lessons';
                        pairLessons.forEach(lesson => {
                            lessonsWrapper.appendChild(createLessonElement(lesson));
                        });
                        card.appendChild(lessonsWrapper);
                        
                        // Добавляем кнопку для домашнего задания (только если есть уроки)
                        if (pairLessons.length > 0 && pairLessons[0].id) {
                            const homeworkButton = document.createElement('button');
                            homeworkButton.className = 'add-homework-btn';
                            homeworkButton.textContent = 'Добавить домашнее задание';
                            homeworkButton.setAttribute('data-lesson-id', pairLessons[0].id);
                            homeworkButton.setAttribute('data-pair-number', pair);
                            homeworkButton.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const subject = pairLessons[0].subject || 'Без предмета';
                                authManager.showHomeworkModal(pairLessons[0].id, subject);
                            });
                            card.appendChild(homeworkButton);
                            
                            console.log('Created homework button for pair', pair, 'lesson', pairLessons[0].id);
                        }
                    }
                    pairsContainer.appendChild(card);
                }
            }
            if (extras.length) {
                const card = document.createElement('article');
                card.className = 'pair-card';
                card.style.cursor = 'pointer';
                card.addEventListener('click', () => openPairModal(extras, 0));
                
                const headerEl = document.createElement('div');
                headerEl.className = 'pair-header';
                const numberSpan = document.createElement('span');
                numberSpan.className = 'pair-number';
                numberSpan.textContent = 'Без номера пары';
                headerEl.appendChild(numberSpan);
                card.appendChild(headerEl);
                const lessonsWrapper = document.createElement('div');
                lessonsWrapper.className = 'pair-lessons';
                extras.forEach(lesson => {
                    lessonsWrapper.appendChild(createLessonElement(lesson));
                });
                card.appendChild(lessonsWrapper);
                
                // Добавляем кнопку для домашнего задания (только если есть уроки)
                if (extras.length > 0 && extras[0].id) {
                    const homeworkButton = document.createElement('button');
                    homeworkButton.className = 'add-homework-btn';
                    homeworkButton.textContent = 'Добавить домашнее задание';
                    homeworkButton.setAttribute('data-lesson-id', extras[0].id);
                    homeworkButton.setAttribute('data-pair-number', '0');
                    homeworkButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const subject = extras[0].subject || 'Без предмета';
                        authManager.showHomeworkModal(extras[0].id, subject);
                    });
                    card.appendChild(homeworkButton);
                    
                    console.log('Created homework button for extras, lesson', extras[0].id);
                }
                
                pairsContainer.appendChild(card);
            }
            dayBlock.appendChild(pairsContainer);
            weeklyScheduleBlock.appendChild(dayBlock);
            
            // Remove loading animation and complete day change animation
            setTimeout(() => {
                if (weeklyScheduleBlock) {
                    weeklyScheduleBlock.classList.remove('loading');
                    weeklyScheduleBlock.classList.remove('day-changing');
                    weeklyScheduleBlock.classList.add('day-changed');
                    
                    // Update current pair highlighting after rendering
                    updateCurrentPairHighlighting();
                    
                    // Update UI permissions after rendering
                    if (typeof authManager !== 'undefined' && authManager.updatePermissionBasedUI) {
                        authManager.updatePermissionBasedUI();
                    }
                }
            }, 50);
        }

        // Elements for weekly mode
        const facultySelect = document.querySelector('#faculty');
        const courseSelect = document.querySelector('#course');
        const groupSelect = document.querySelector('#group');
        const loadButton = document.querySelector('#load');
        const statusBox = document.querySelector('#status');
        const fromInput = document.querySelector('#from');
        const toInput = document.querySelector('#to');
        const headerTitle = document.querySelector('.app-header__title');
        const headerSubtitle = document.querySelector('.app-header__subtitle');
        const themeToggle = document.querySelector('#theme-toggle');
        const followSystemThemeToggle = document.querySelector('#follow-system-theme');
        const loadingOverlayWeekly = document.querySelector('#loading-overlay-weekly');
        

        function showLoading(target) {
            if (loadingOverlayWeekly) {
                loadingOverlayWeekly.classList.add('visible');
                loadingOverlayWeekly.setAttribute('aria-hidden', 'false');
            }
        }

        function hideLoading(target) {
            if (loadingOverlayWeekly) {
                loadingOverlayWeekly.classList.remove('visible');
                loadingOverlayWeekly.setAttribute('aria-hidden', 'true');
            }
        }

        // Функция для получения системной темы
        function getSystemTheme() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        // Функция для применения темы
        function applyTheme(theme) {
            const root = document.documentElement;
            root.setAttribute('data-theme', theme);
            if (themeToggle) {
                themeToggle.checked = theme === 'dark';
            }
            
            // Обновляем изображения в зависимости от темы
            updateTabImages(theme);
        }

        // Функция для обновления изображений в навигационных кнопках
        function updateTabImages(theme) {
            const tabImages = document.querySelectorAll('.tab-item__icon');
            tabImages.forEach(img => {
                const lightSrc = img.getAttribute('data-light');
                const darkSrc = img.getAttribute('data-dark');
                
                if (theme === 'dark' && darkSrc) {
                    img.src = darkSrc;
                } else if (theme === 'light' && lightSrc) {
                    img.src = lightSrc;
                }
            });
        }

        // Функция для обновления состояния переключателей
        function updateThemeControls() {
            const followSystem = localStorage.getItem('followSystemTheme') === 'true';
            const savedTheme = localStorage.getItem('theme');
            
            if (followSystemThemeToggle) {
                followSystemThemeToggle.checked = followSystem;
            }
            
            if (followSystem) {
                // Следуем системной теме
                const systemTheme = getSystemTheme();
                applyTheme(systemTheme);
                if (themeToggle) {
                    themeToggle.disabled = true;
                }
            } else {
                // Используем сохраненную тему
                const theme = savedTheme || 'light';
                applyTheme(theme);
                if (themeToggle) {
                    themeToggle.disabled = false;
                }
            }
        }

        // Функция переключения темы (только когда не следует системной теме)
        function toggleTheme() {
            const followSystem = localStorage.getItem('followSystemTheme') === 'true';
            if (followSystem) return; // Не переключаем, если следует системной теме
            
            const root = document.documentElement;
            const current = root.getAttribute('data-theme') || 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Функция переключения следования системной теме
        function toggleFollowSystemTheme() {
            const followSystem = followSystemThemeToggle.checked;
            localStorage.setItem('followSystemTheme', followSystem);
            
            if (followSystem) {
                // Начинаем следовать системной теме
                const systemTheme = getSystemTheme();
                applyTheme(systemTheme);
                if (themeToggle) {
                    themeToggle.disabled = true;
                }
            } else {
                // Переходим на ручное управление
                const savedTheme = localStorage.getItem('theme') || 'light';
                applyTheme(savedTheme);
                if (themeToggle) {
                    themeToggle.disabled = false;
                }
            }
        }

        // Обработчики событий
        if (themeToggle) {
            themeToggle.addEventListener('change', toggleTheme);
        }
        
        if (followSystemThemeToggle) {
            followSystemThemeToggle.addEventListener('change', toggleFollowSystemTheme);
        }

        // Слушатель изменений системной темы
        if (window.matchMedia) {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', function(e) {
                const followSystem = localStorage.getItem('followSystemTheme') === 'true';
                if (followSystem) {
                    const systemTheme = e.matches ? 'dark' : 'light';
                    applyTheme(systemTheme);
                }
            });
        }

        // Инициализация темы без анимации при загрузке страницы
        updateThemeControls();
        
        // Включаем анимации после загрузки страницы
        setTimeout(() => {
            document.documentElement.classList.add('theme-animations-enabled');
        }, 100);

        // Font Size
        const fontSizeSelect = document.querySelector('#font-size');
        if (fontSizeSelect) {
            fontSizeSelect.addEventListener('change', (e) => {
                const fontSize = e.target.value;
                document.documentElement.setAttribute('data-font-size', fontSize);
                localStorage.setItem('fontSize', fontSize);
            });

            // Load saved font size
            const savedFontSize = localStorage.getItem('fontSize') || 'medium';
            fontSizeSelect.value = savedFontSize;
            document.documentElement.setAttribute('data-font-size', savedFontSize);
        }

        let currentGroupName = '';

        const tabItems = Array.from(document.querySelectorAll('.tab-item'));
        const tabPanels = Array.from(document.querySelectorAll('.tab-content'));

        function setHeaderSubtitle(value) {
            if (!headerSubtitle) {
                return;
            }
            if (value) {
                headerSubtitle.textContent = value;
                headerSubtitle.classList.remove('hidden');
            } else {
                headerSubtitle.textContent = '';
                headerSubtitle.classList.add('hidden');
            }
        }

        function updateHeader(target) {
            if (!headerTitle) {
                return;
            }
            
            // Show/hide week navigation based on current tab
            if (weekNavigation) {
                weekNavigation.style.display = target === 'schedule' ? 'flex' : 'none';
            }
            
            // Show/hide news search based on current tab
            const newsSearchHeader = document.getElementById('news-search-header');
            if (newsSearchHeader) {
                newsSearchHeader.style.display = target === 'news' ? 'flex' : 'none';
            }
            
            switch (target) {
                case 'news':
                    headerTitle.textContent = 'Лента';
                    setHeaderSubtitle('');
                    break;
                case 'schedule':
                    headerTitle.textContent = 'Расписание';
                    setHeaderSubtitle(currentGroupName);
                    break;
                case 'settings':
                    headerTitle.textContent = 'Настройки';
                    setHeaderSubtitle('');
                    break;
                default:
                    break;
            }
        }

        function optionLabel(select) {
            if (!select) {
                return '';
            }
            const option = select.options[select.selectedIndex];
            return option ? option.textContent.trim() : '';
        }

        function activateTab(target) {
            tabItems.forEach(item => {
                const isActive = item.dataset.tab === target;
                item.classList.toggle('active', isActive);
                item.setAttribute('aria-selected', String(isActive));
                item.tabIndex = isActive ? 0 : -1;
            });
            tabPanels.forEach(panel => {
                panel.classList.toggle('active', panel.dataset.tab === target);
                panel.hidden = panel.dataset.tab !== target;
            });
            updateHeader(target);
        }

        tabItems.forEach(item => {
            // Skip removed weekly tab id if present in DOM snapshot
            item.addEventListener('click', () => activateTab(item.dataset.tab));
        });

        // Welcome Modal Functions
        function checkAndShowWelcomeModal() {
            const hasSeenWelcome = localStorage.getItem('schedule-app-welcome-seen');
            if (!hasSeenWelcome) {
                showWelcomeModal();
            }
        }

        function showWelcomeModal() {
            const modal = document.getElementById('welcome-modal');
            if (modal) {
                modal.style.display = 'flex';
                loadWelcomeFaculties();
                setupWelcomeEventListeners();
            }
        }

        function hideWelcomeModal() {
            const modal = document.getElementById('welcome-modal');
            if (modal) {
                modal.style.animation = 'welcomeModalSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.style.animation = '';
                }, 300);
                localStorage.setItem('schedule-app-welcome-seen', 'true');
            }
        }

        async function loadWelcomeFaculties() {
            try {
                const response = await fetch('/api/options/faculties');
                const faculties = await response.json();
                
                const select = document.getElementById('welcome-faculty');
                if (select) {
                    select.innerHTML = '<option value="">Выберите факультет</option>';
                    faculties.forEach(faculty => {
                        const option = document.createElement('option');
                        option.value = faculty.id;
                        option.textContent = faculty.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading faculties for welcome modal:', error);
            }
        }

        function setupWelcomeEventListeners() {
            const welcomeFaculty = document.getElementById('welcome-faculty');
            const welcomeCourse = document.getElementById('welcome-course');
            const welcomeGroup = document.getElementById('welcome-group');
            const welcomeContinue = document.getElementById('welcome-continue');
            const welcomeSkip = document.getElementById('welcome-skip');
            const welcomeOverlay = document.querySelector('.welcome-modal__overlay');

            if (welcomeFaculty) {
                welcomeFaculty.addEventListener('change', async (e) => {
                    const facultyId = e.target.value;
                    if (facultyId) {
                        await loadWelcomeCourses(facultyId);
                        updateWelcomeSteps(2); // Активируем второй шаг (курс)
                    } else {
                        resetWelcomeForm();
                    }
                });
            }

            if (welcomeCourse) {
                welcomeCourse.addEventListener('change', async (e) => {
                    const facultyId = welcomeFaculty.value;
                    const courseId = e.target.value;
                    if (facultyId && courseId) {
                        await loadWelcomeGroups(facultyId, courseId);
                        updateWelcomeSteps(3); // Активируем третий шаг (группа)
                    } else {
                        resetWelcomeGroups();
                    }
                });
            }

            if (welcomeGroup) {
                welcomeGroup.addEventListener('change', (e) => {
                    if (e.target.value) {
                        // Все шаги завершены
                        updateWelcomeSteps(4); // 4 означает, что все шаги завершены
                    } else {
                        updateWelcomeSteps(3); // Только третий шаг активен
                    }
                    updateWelcomeContinueButton();
                });
            }

            if (welcomeContinue) {
                welcomeContinue.addEventListener('click', () => {
                    const facultyId = welcomeFaculty.value;
                    const courseId = welcomeCourse.value;
                    const groupId = welcomeGroup.value;
                    
                    if (facultyId && courseId && groupId) {
                        // Set the selection in main form
                        setWelcomeSelection(facultyId, courseId, groupId);
                        hideWelcomeModal();
                    }
                });
            }

            if (welcomeSkip) {
                welcomeSkip.addEventListener('click', () => {
                    hideWelcomeModal();
                });
            }

            if (welcomeOverlay) {
                welcomeOverlay.addEventListener('click', () => {
                    hideWelcomeModal();
                });
            }
        }

        async function loadWelcomeCourses(facultyId) {
            try {
                const response = await fetch(`/api/options/courses?faculty=${facultyId}`);
                const courses = await response.json();
                
                const select = document.getElementById('welcome-course');
                if (select) {
                    select.innerHTML = '<option value="">Выберите курс</option>';
                    select.disabled = false;
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading courses for welcome modal:', error);
            }
        }

        async function loadWelcomeGroups(facultyId, courseId) {
            try {
                const response = await fetch(`/api/options/groups?faculty=${facultyId}&course=${courseId}`);
                const groups = await response.json();
                
                const select = document.getElementById('welcome-group');
                if (select) {
                    select.innerHTML = '<option value="">Выберите группу</option>';
                    select.disabled = false;
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading groups for welcome modal:', error);
            }
        }

        function updateWelcomeSteps(currentStep) {
            const steps = document.querySelectorAll('.welcome-step');
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep && currentStep <= 3) {
                    step.classList.add('active');
                } else if (currentStep > 3) {
                    // Если все шаги завершены (currentStep > 3), помечаем все как завершенные
                    step.classList.add('completed');
                }
            });
        }

        function updateWelcomeContinueButton() {
            const faculty = document.getElementById('welcome-faculty').value;
            const course = document.getElementById('welcome-course').value;
            const group = document.getElementById('welcome-group').value;
            const continueBtn = document.getElementById('welcome-continue');
            
            if (continueBtn) {
                const allSelected = faculty && course && group;
                continueBtn.disabled = !allSelected;
                
                // Обновляем текст кнопки в зависимости от состояния
                if (allSelected) {
                    continueBtn.textContent = 'Готово!';
                } else {
                    continueBtn.textContent = 'Продолжить';
                }
            }
        }

        function resetWelcomeForm() {
            const courseSelect = document.getElementById('welcome-course');
            const groupSelect = document.getElementById('welcome-group');
            
            if (courseSelect) {
                courseSelect.innerHTML = '<option value="">Сначала выберите факультет</option>';
                courseSelect.disabled = true;
            }
            
            if (groupSelect) {
                groupSelect.innerHTML = '<option value="">Сначала выберите курс</option>';
                groupSelect.disabled = true;
            }
            
            updateWelcomeSteps(1); // Возвращаемся к первому шагу
            updateWelcomeContinueButton();
        }

        function resetWelcomeGroups() {
            const groupSelect = document.getElementById('welcome-group');
            
            if (groupSelect) {
                groupSelect.innerHTML = '<option value="">Сначала выберите курс</option>';
                groupSelect.disabled = true;
            }
            
            updateWelcomeSteps(2); // Возвращаемся ко второму шагу (курс)
            updateWelcomeContinueButton();
        }

        function setWelcomeSelection(facultyId, courseId, groupId) {
            // Set the main form values
            const facultySelect = document.getElementById('faculty');
            const courseSelect = document.getElementById('course');
            const groupSelect = document.getElementById('group');
            
            if (facultySelect) {
                facultySelect.value = facultyId;
                facultySelect.dispatchEvent(new Event('change'));
            }
            
            // Wait a bit for courses to load, then set course
            setTimeout(() => {
                if (courseSelect) {
                    courseSelect.value = courseId;
                    courseSelect.dispatchEvent(new Event('change'));
                }
                
                // Wait a bit more for groups to load, then set group
                setTimeout(() => {
                    if (groupSelect) {
                        groupSelect.value = groupId;
                        groupSelect.dispatchEvent(new Event('change'));
                        
                        // Automatically load schedule after setting all values
                        setTimeout(() => {
                            loadSchedule();
                        }, 300);
                    }
                }, 500);
            }, 500);
        }

        // Initialize weekly mode
        function initializeWeeklyMode() {
            if (weeklyScheduleBlock) {
                weeklyScheduleBlock.innerHTML = '<div class="placeholder-card">Загружаем…</div>';
            }
            // Set current week to today's week
            currentWeekMonday = getMonday(new Date());
            // Initialize with today's date selected
            currentlySelectedDate = formatAPIDate(new Date());
            renderWeeklyDateSelector(true);
            
            // Start current pair updates
            startCurrentPairUpdates();
            
            // Select today's date if available, otherwise select first available day
            setTimeout(() => {
                const todayStr = formatAPIDate(new Date());
                const todayBtn = Array.from(weeklyDateSelector.querySelectorAll('button')).find(b => b.dataset.date === todayStr);
                if (todayBtn) {
                    selectWeeklyDate(todayBtn.dataset.date, todayBtn);
                } else {
                    // If today is not in the current week, select the first day
                    const firstBtn = weeklyDateSelector.querySelector('button');
                    if (firstBtn) selectWeeklyDate(firstBtn.dataset.date, firstBtn);
                }
            }, 0);
        }


        const API = {
            faculties: '/api/options/faculties',
            courses: faculty => `/api/options/courses?faculty=${encodeURIComponent(faculty)}`,
            groups: (faculty, course) => `/api/options/groups?faculty=${encodeURIComponent(faculty)}&course=${encodeURIComponent(course)}`,
            schedule: params => `/api/schedule?${new URLSearchParams(params).toString()}`,
        };

        const MONTHS = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
        const WEEKDAYS = ['воскресенье', 'понедельник', 'вторник', 'среда', 'четверг', 'пятница', 'суббота'];

        let aggregatedLessons = [];
        let currentSelection = { faculty: '', course: '', group: '', facultyLabel: '', courseLabel: '', groupLabel: '' };
        let currentRange = { from: '', to: '' };
        const STORAGE_KEY = "schedule:lastSelection";
        const CACHE_KEY_PREFIX = "schedule:cache:";
        const CACHE_TTL = 30 * 60 * 1000; // 30 минут
        let currentAbortController = null;
        let persistedSelection = readSavedSelection();
        currentGroupName = persistedSelection && persistedSelection.groupLabel ? String(persistedSelection.groupLabel) : '';
        let restoringSelection = false;

        if (persistedSelection) {
            currentSelection = { ...currentSelection, ...persistedSelection };
        }
        activateTab('schedule');
        // Initialize weekly mode
        initializeWeeklyMode();

        // Check if user is new and show welcome modal
        checkAndShowWelcomeModal();

        // Debug function to reset welcome modal (for testing)
        window.resetWelcomeModal = function() {
            localStorage.removeItem('schedule-app-welcome-seen');
            showWelcomeModal();
        };


        initializeDefaultDates();
        loadFaculties().then(() => {
            if (persistedSelection) {
                restoreSelection(persistedSelection);
            }
        });

        facultySelect.addEventListener('change', event => {
            const faculty = event.target.value;
            clearSchedule();
            loadCourses(faculty);
        });

        courseSelect.addEventListener('change', event => {
            const course = event.target.value;
            const faculty = facultySelect.value;
            clearSchedule();
            loadGroups(faculty, course);
        });

        groupSelect.addEventListener('change', event => {
            loadButton.disabled = !event.target.value;
            clearSchedule();
        });

        loadButton.addEventListener('click', () => {
            loadSchedule();
        });

        

        // Cache management
        function getCacheKey(params) {
            return `${CACHE_KEY_PREFIX}${params.faculty}-${params.course}-${params.group}-${params.from}-${params.to}`;
        }

        function getCachedData(cacheKey) {
            try {
                const cached = localStorage.getItem(cacheKey);
                if (!cached) return null;
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp > CACHE_TTL) {
                    localStorage.removeItem(cacheKey);
                    return null;
                }
                return data;
            } catch (error) {
                console.warn('Cache read error:', error);
                return null;
            }
        }

        function setCachedData(cacheKey, data) {
            try {
                const cacheData = { data, timestamp: Date.now() };
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
            } catch (error) {
                console.warn('Cache write error:', error);
            }
        }

        async function fetchJson(url, { mode = 'feed', useCache = true, cacheKey = null } = {}) {
            // Check cache first
            if (useCache && cacheKey) {
                const cached = getCachedData(cacheKey);
                if (cached) {
                    return cached;
                }
            }

            // Cancel previous request
            if (currentAbortController) {
                currentAbortController.abort();
            }
            currentAbortController = new AbortController();

            showLoading(mode === 'weekly' ? 'weekly' : 'feed');
            try {
                const response = await fetch(url, { signal: currentAbortController.signal });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `Ошибка ${response.status}`);
                }
                const data = await response.json();
                
                // Cache the result
                if (useCache && cacheKey) {
                    setCachedData(cacheKey, data);
                }
                
                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Запрос отменён');
                }
                throw error;
            } finally {
                hideLoading(mode === 'weekly' ? 'weekly' : 'feed');
                currentAbortController = null;
            }
        }

        function setStatus(message, isError = false) {
            // Показываем только ошибки, обычные сообщения скрываем
            if (isError) {
                statusBox.textContent = message || '';
                statusBox.style.color = '#b91c1c';
            } else {
                // Скрываем обычные информационные сообщения
                statusBox.textContent = '';
                statusBox.style.color = 'var(--muted)';
            }
        }

        function resetSelect(select, placeholder, disabled = true) {
            select.innerHTML = '';
            const option = document.createElement('option');
            option.value = '';
            option.textContent = placeholder;
            select.appendChild(option);
            select.disabled = disabled;
        }

        function clearSchedule() {
            aggregatedLessons = [];
        }
        function readSavedSelection() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) {
                    return null;
                }
                const parsed = JSON.parse(raw);
                if (parsed && parsed.faculty && parsed.course && parsed.group) {
                    return {
                        faculty: String(parsed.faculty),
                        course: String(parsed.course),
                        group: String(parsed.group),
                        facultyLabel: parsed.facultyLabel ? String(parsed.facultyLabel) : '',
                        courseLabel: parsed.courseLabel ? String(parsed.courseLabel) : '',
                        groupLabel: parsed.groupLabel ? String(parsed.groupLabel) : '',
                    };
                }
            } catch (error) {
                console.warn("Failed to read saved selection", error);
            }
            return null;
        }

        function saveSelection(selection) {
            if (!selection || !selection.faculty || !selection.course || !selection.group) {
                return;
            }
            try {
                persistedSelection = { ...selection };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(persistedSelection));
            } catch (error) {
                console.warn("Failed to persist selection", error);
            }
        }

        function clearSavedSelection() {
            persistedSelection = null;
            currentGroupName = '';
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (error) {
                console.warn("Failed to clear saved selection", error);
            }
            const activeTab = document.querySelector('.tab-item.active');
            if (activeTab && activeTab.dataset.tab === 'schedule') {
                updateHeader('schedule');
            }
        }

        function selectHasOption(select, value) {
            if (!value) {
                return false;
            }
            const target = String(value);
            return Array.from(select.options).some(option => option.value === target);
        }

        async function restoreSelection(saved) {
            if (!saved) {
                return;
            }
            if (!selectHasOption(facultySelect, saved.faculty)) {
                clearSavedSelection();
                return;
            }
            restoringSelection = true;
            try {
                facultySelect.value = saved.faculty;
                await loadCourses(saved.faculty);
                if (!selectHasOption(courseSelect, saved.course)) {
                    clearSavedSelection();
                    return;
                }
                courseSelect.value = saved.course;
                await loadGroups(saved.faculty, saved.course);
                if (!selectHasOption(groupSelect, saved.group)) {
                    clearSavedSelection();
                    return;
                }
                groupSelect.value = saved.group;
                const facultyLabel = optionLabel(facultySelect);
                const courseLabel = optionLabel(courseSelect);
                const groupLabel = optionLabel(groupSelect) || saved.groupLabel || '';
                currentSelection = {
                    faculty: saved.faculty,
                    course: saved.course,
                    group: saved.group,
                    facultyLabel,
                    courseLabel,
                    groupLabel,
                };
                currentGroupName = groupLabel;
                updateHeader('schedule');

                loadButton.disabled = false;
                await loadSchedule();
            } finally {
                restoringSelection = false;
            }
        }


        function initializeDefaultDates() {
            const today = new Date();
            // Устанавливаем диапазон на месяц назад и месяц вперед
            const start = addDays(today, -30); // месяц назад
            const end = addDays(today, 30);    // месяц вперед
            fromInput.value = formatDateInput(start);
            toInput.value = formatDateInput(end);
        }

        async function loadFaculties() {
            setStatus('Загружаем список факультетов…');
            try {
                const faculties = await fetchJson(API.faculties);
                resetSelect(facultySelect, 'Выберите факультет', false);
                faculties.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    facultySelect.appendChild(option);
                });
                setStatus('Факультеты загружены.');
            } catch (error) {
                setStatus(`Не удалось получить факультеты: ${error.message}`, true);
            }
        }

        async function loadCourses(faculty) {
            resetSelect(courseSelect, faculty ? 'Загружаем…' : 'Сначала выберите факультет', true);
            resetSelect(groupSelect, 'Сначала выберите курс', true);
            loadButton.disabled = true;
            if (!faculty) {
                return;
            }
            setStatus('Получаем курсы…');
            try {
                const courses = await fetchJson(API.courses(faculty));
                resetSelect(courseSelect, 'Выберите курс', false);
                courses.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    courseSelect.appendChild(option);
                });
                setStatus('Выберите курс.');
            } catch (error) {
                setStatus(`Не удалось получить курсы: ${error.message}`, true);
            }
        }

        async function loadGroups(faculty, course) {
            resetSelect(groupSelect, course ? 'Загружаем…' : 'Сначала выберите курс', true);
            loadButton.disabled = true;
            if (!course) {
                return;
            }
            setStatus('Ищем группы…');
            try {
                const groups = await fetchJson(API.groups(faculty, course));
                resetSelect(groupSelect, 'Выберите группу', false);
                groups.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    groupSelect.appendChild(option);
                });
                setStatus('Группа готова к выбору.');
            } catch (error) {
                setStatus(`Не удалось получить группы: ${error.message}`, true);
            }
        }

        async function loadSchedule() {
            const faculty = facultySelect.value;
            const course = courseSelect.value;
            const group = groupSelect.value;
            if (!faculty || !course || !group) {
                setStatus('Пожалуйста, заполните все параметры.', true);
                return;
            }

            const params = { faculty, course, group };
            let fromValue = fromInput.value;
            let toValue = toInput.value;
            if (!fromValue) {
                const today = new Date();
                fromValue = formatDateInput(today);
            }
            if (!toValue) {
                const base = parseInputDate(fromValue);
                toValue = formatDateInput(addDays(base, 6));
            }
            params.from = fromValue;
            params.to = toValue;
            fromInput.value = fromValue;
            toInput.value = toValue;

            const facultyLabel = optionLabel(facultySelect);
            const courseLabel = optionLabel(courseSelect);
            const groupLabel = optionLabel(groupSelect);

            currentSelection = {
                faculty,
                course,
                group,
                facultyLabel,
                courseLabel,
                groupLabel,
            };
            currentGroupName = groupLabel;
            currentRange = { from: fromValue, to: toValue };
            
            // Initialize synchronized week state based on today's date, not the range start
            currentWeekMonday = getMonday(new Date());
            
            updateHeader('schedule');

            const cacheKey = getCacheKey(params);
            
            // Check cache first and show immediately
            const cachedData = getCachedData(cacheKey);
            if (cachedData) {
                const total = updateSchedule(cachedData.lessons || [], { append: false });
                activateTab('schedule');
                saveSelection(currentSelection);
                if (total) {
                    setStatus(`Найдено занятий: ${total} (из кэша)`);
                        refreshWeeklySelectionAfterData();
                } else {
                    setStatus('Для выбранных параметров занятий не найдено.');
                }
                
                // Preload multiple weeks in background
                preloadWeeks();
            }

            setStatus('Загружаем расписание…');
            loadButton.disabled = true;

            try {
                const data = await fetchJson(API.schedule(params), { 
                    mode: 'weekly',
                    useCache: true,
                    cacheKey: cacheKey
                });
                const total = updateSchedule(data.lessons || [], { append: false });
                activateTab('schedule');
                saveSelection(currentSelection);
                if (total) {
                    setStatus(`Найдено занятий: ${total}`);
                        refreshWeeklySelectionAfterData();
                } else {
                    setStatus('Для выбранных параметров занятий не найдено.');
                }
            } catch (error) {
                setStatus(`Не удалось получить расписание: ${error.message}`, true);
            } finally {
                loadButton.disabled = !groupSelect.value;
            }
        }

        // Preload next week in background
        async function preloadNextWeek() {
            if (!currentSelection.group) return;
            
            const baseDate = currentRange.to || currentRange.from;
            const lastDate = baseDate ? parseInputDate(baseDate) : addDays(new Date(), 6);
            const nextFrom = addDays(lastDate, 1);
            const nextTo = addDays(nextFrom, 6);

            const params = {
                faculty: currentSelection.faculty,
                course: currentSelection.course,
                group: currentSelection.group,
                from: formatDateInput(nextFrom),
                to: formatDateInput(nextTo),
            };

            const cacheKey = getCacheKey(params);
            if (getCachedData(cacheKey)) return; // Already cached

            try {
                await fetchJson(API.schedule(params), { 
                    mode: 'feed',
                    useCache: true,
                    cacheKey: cacheKey
                });
            } catch (error) {
                // Silent fail for background preload
                console.warn('Background preload failed:', error);
            }
        }

        // Preload previous week in background
        async function preloadPreviousWeek() {
            if (!currentSelection.group) return;
            
            const baseDate = currentRange.from || currentRange.to;
            const firstDate = baseDate ? parseInputDate(baseDate) : new Date();
            const prevTo = addDays(firstDate, -1);
            const prevFrom = addDays(prevTo, -6);

            const params = {
                faculty: currentSelection.faculty,
                course: currentSelection.course,
                group: currentSelection.group,
                from: formatDateInput(prevFrom),
                to: formatDateInput(prevTo),
            };

            const cacheKey = getCacheKey(params);
            if (getCachedData(cacheKey)) return; // Already cached

            try {
                await fetchJson(API.schedule(params), { 
                    mode: 'feed',
                    useCache: true,
                    cacheKey: cacheKey
                });
            } catch (error) {
                // Silent fail for background preload
                console.warn('Background preload failed:', error);
            }
        }

        // Preload multiple weeks (4 forward, 4 backward for extended range)
        async function preloadWeeks() {
            if (!currentSelection.group) return;
            
            const preloadPromises = [];
            
            // Preload 4 weeks forward
            for (let i = 1; i <= 4; i++) {
                const baseDate = currentRange.to || currentRange.from;
                const lastDate = baseDate ? parseInputDate(baseDate) : addDays(new Date(), 6);
                const weekFrom = addDays(lastDate, (i - 1) * 7 + 1);
                const weekTo = addDays(weekFrom, 6);

                const params = {
                    faculty: currentSelection.faculty,
                    course: currentSelection.course,
                    group: currentSelection.group,
                    from: formatDateInput(weekFrom),
                    to: formatDateInput(weekTo),
                };

                const cacheKey = getCacheKey(params);
                if (!getCachedData(cacheKey)) {
                    preloadPromises.push(
                        fetchJson(API.schedule(params), { 
                            mode: 'weekly',
                            useCache: true,
                            cacheKey: cacheKey
                        }).catch(error => {
                            console.warn(`Background preload week +${i} failed:`, error);
                        })
                    );
                }
            }
            
            // Preload 4 weeks backward
            for (let i = 1; i <= 4; i++) {
                const baseDate = currentRange.from || currentRange.to;
                const firstDate = baseDate ? parseInputDate(baseDate) : new Date();
                const weekTo = addDays(firstDate, -1 - (i - 1) * 7);
                const weekFrom = addDays(weekTo, -6);

                const params = {
                    faculty: currentSelection.faculty,
                    course: currentSelection.course,
                    group: currentSelection.group,
                    from: formatDateInput(weekFrom),
                    to: formatDateInput(weekTo),
                };

                const cacheKey = getCacheKey(params);
                if (!getCachedData(cacheKey)) {
                    preloadPromises.push(
                        fetchJson(API.schedule(params), { 
                            mode: 'weekly',
                            useCache: true,
                            cacheKey: cacheKey
                        }).catch(error => {
                            console.warn(`Background preload week -${i} failed:`, error);
                        })
                    );
                }
            }
            
            // Execute all preloads in parallel
            await Promise.allSettled(preloadPromises);
        }






        function updateSchedule(lessons, { append = false } = {}) {
            if (!append) {
                aggregatedLessons = Array.isArray(lessons) ? [...lessons] : [];
            } else {
                const seen = new Set(aggregatedLessons.map(item => item.id));
                lessons.forEach(lesson => {
                    if (lesson && lesson.id && !seen.has(lesson.id)) {
                        aggregatedLessons.push(lesson);
                        seen.add(lesson.id);
                    }
                });
            }
            aggregatedLessons.sort(compareLessons);
            renderScheduleBlocks(aggregatedLessons);
            
            
            return aggregatedLessons.length;
        }

        function renderScheduleBlocks(lessons) {
            // This function is kept for compatibility but doesn't render anything
            // since we're only using weekly mode now
                return;
        }

        function createLessonElement(lesson) {
            const container = document.createElement('div');
            container.className = 'lesson-detail';

            const subject = document.createElement('div');
            subject.className = 'lesson-subject';
            subject.textContent = lesson.subject || 'Без предмета';
            container.appendChild(subject);

            const meta = document.createElement('div');
            meta.className = 'lesson-meta';
            const metaItems = [];
            if (lesson.type) {
                const typeBadge = document.createElement('span');
                typeBadge.className = 'badge';
                typeBadge.textContent = lesson.type;
                const normalizedType = (lesson.type || '').toLowerCase();
                if (normalizedType.includes('лк')) {
                    typeBadge.classList.add('badge-lecture');
                } else if (normalizedType.includes('сем')) {
                    typeBadge.classList.add('badge-seminar');
                }
                metaItems.push(typeBadge);
            }
            if (lesson.teacher) {
                const teacher = document.createElement('span');
                teacher.textContent = lesson.teacher;
                metaItems.push(teacher);
            }
            if (lesson.room) {
                const room = document.createElement('span');
                room.textContent = lesson.room;
                metaItems.push(room);
            }
            metaItems.forEach(node => meta.appendChild(node));
            if (metaItems.length) {
                container.appendChild(meta);
            }

            if (lesson.notes) {
                const rawNotes = String(lesson.notes).trim();
                if (rawNotes && !rawNotes.toLowerCase().startsWith('добавлено')) {
                    const notes = document.createElement('div');
                    notes.className = 'lesson-notes';
                    notes.textContent = rawNotes;
                    container.appendChild(notes);
                }
            }


            return container;
        }

        // Функции для работы с модальным окном карточки пары
        function openPairModal(lessons, pairNumber) {
            if (!lessons || lessons.length === 0) return;
            
            const modal = document.getElementById('pair-modal');
            const typeBadge = modal.querySelector('.pair-type-badge');
            const timeElement = modal.querySelector('.pair-time');
            const titleElement = modal.querySelector('.pair-title');
            const teacherElement = modal.querySelector('.pair-teacher');
            const roomElement = modal.querySelector('.pair-room');
            const notesElement = modal.querySelector('.pair-notes');
            
            // Получаем данные из первого урока (предполагаем, что все уроки в паре имеют одинаковые основные данные)
            const lesson = lessons[0];
            
            // Определяем тип пары
            const lessonType = lesson.type || 'Занятие';
            const normalizedType = lessonType.toLowerCase();
            let typeClass = 'other';
            
            if (normalizedType.includes('лк') || normalizedType.includes('лекция')) {
                typeClass = 'lecture';
            } else if (normalizedType.includes('сем') || normalizedType.includes('семинар')) {
                typeClass = 'seminar';
            } else if (normalizedType.includes('пр') || normalizedType.includes('практика')) {
                typeClass = 'practical';
            } else if (normalizedType.includes('лаб') || normalizedType.includes('лабораторная')) {
                typeClass = 'lab';
            }
            
            // Устанавливаем тип пары
            typeBadge.textContent = lessonType;
            typeBadge.className = `pair-type-badge ${typeClass}`;
            
            // Устанавливаем время
            if (lesson.starts_at) {
                // Время уже приходит в формате "HH:MM", просто отображаем его
                timeElement.textContent = lesson.starts_at;
            } else if (lesson.ends_at) {
                // Если есть только время окончания, показываем его
                timeElement.textContent = lesson.ends_at;
            } else {
                timeElement.textContent = '';
            }
            
            // Устанавливаем название пары
            titleElement.textContent = lesson.subject || 'Без предмета';
            
            // Устанавливаем преподавателя
            if (lesson.teacher) {
                teacherElement.textContent = lesson.teacher;
                teacherElement.style.display = 'block';
            } else {
                teacherElement.style.display = 'none';
            }
            
            // Устанавливаем аудиторию
            if (lesson.room) {
                roomElement.textContent = lesson.room;
                roomElement.style.display = 'flex';
            } else {
                roomElement.style.display = 'none';
            }
            
            // Устанавливаем заметки
            if (lesson.notes) {
                const rawNotes = String(lesson.notes).trim();
                if (rawNotes && !rawNotes.toLowerCase().startsWith('добавлено')) {
                    notesElement.textContent = rawNotes;
                    notesElement.style.display = 'block';
                } else {
                    notesElement.style.display = 'none';
                }
            } else {
                notesElement.style.display = 'none';
            }
            
            // Загружаем домашние задания для урока
            loadLessonHomework(lesson.id);
            
            // Показываем модальное окно
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePairModal() {
            const modal = document.getElementById('pair-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        async function loadLessonHomework(lessonId) {
            if (!lessonId) {
                hideHomeworkSection();
                return;
            }

            try {
                const initData = window.Telegram?.WebApp?.initData || '';
                const currentUser = window.authManager?.currentUser;
                
                if (!currentUser || !currentUser.group_id) {
                    hideHomeworkSection();
                    return;
                }

                const response = await fetch(`/api/schedule/homework/${currentUser.group_id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(initData && { 'X-Telegram-Init-Data': initData })
                    }
                });

                if (!response.ok) {
                    console.error('Failed to load homework:', response.status);
                    hideHomeworkSection();
                    return;
                }

                const result = await response.json();
                
                if (result.success && result.homework_tasks) {
                    // Ищем домашнее задание для конкретного урока
                    const homework = result.homework_tasks.find(hw => hw.lesson_id === lessonId);
                    
                    if (homework) {
                        showHomeworkInModal(homework.homework_text, lessonId);
                    } else {
                        showAddHomeworkButton(lessonId);
                    }
                } else {
                    showAddHomeworkButton(lessonId);
                }
            } catch (error) {
                console.error('Error loading homework:', error);
                hideHomeworkSection();
            }
        }

        function showHomeworkInModal(homeworkText, lessonId) {
            const modal = document.getElementById('pair-modal');
            const homeworkDisplay = modal.querySelector('.pair-homework-display');
            const homeworkAdd = modal.querySelector('.pair-homework-add');
            const homeworkTextSpan = modal.querySelector('.homework-text');
            
            if (homeworkDisplay && homeworkTextSpan) {
                homeworkTextSpan.textContent = homeworkText;
                homeworkDisplay.style.display = 'block';
                homeworkAdd.style.display = 'none';
                
                // Проверяем права пользователя
                const currentUser = window.authManager?.currentUser;
                const isAdmin = currentUser && (currentUser.role === 'admin' || 
                    (currentUser.username && currentUser.username.toLowerCase() === 'david_nazaryan'));
                const canEdit = window.authManager?.permissions?.canEdit || isAdmin;
                
                // Добавляем обработчики для кнопок редактирования и удаления
                const editBtn = modal.querySelector('.edit-homework-btn');
                const deleteBtn = modal.querySelector('.delete-homework-btn');
                const homeworkActions = modal.querySelector('.homework-actions');
                
                if (canEdit) {
                    // Показываем кнопки редактирования и удаления
                    if (homeworkActions) {
                        homeworkActions.style.display = 'flex';
                    }
                    
                    if (editBtn) {
                        editBtn.onclick = () => {
                            const newText = prompt('Редактировать домашнее задание:', homeworkText);
                            if (newText && newText.trim() !== homeworkText.trim()) {
                                updateLessonHomework(lessonId, newText.trim());
                            }
                        };
                    }
                    
                    if (deleteBtn) {
                        deleteBtn.onclick = () => {
                            if (confirm('Удалить домашнее задание?')) {
                                deleteLessonHomework(lessonId);
                            }
                        };
                    }
                } else {
                    // Скрываем кнопки редактирования и удаления для студентов
                    if (homeworkActions) {
                        homeworkActions.style.display = 'none';
                    }
                }
            }
        }

        function showAddHomeworkButton(lessonId) {
            const modal = document.getElementById('pair-modal');
            const homeworkDisplay = modal.querySelector('.pair-homework-display');
            const homeworkAdd = modal.querySelector('.pair-homework-add');
            const addBtn = modal.querySelector('.add-homework-btn-modal');
            
            if (homeworkDisplay && homeworkAdd && addBtn) {
                homeworkDisplay.style.display = 'none';
                
                // Проверяем права пользователя
                const currentUser = window.authManager?.currentUser;
                const isAdmin = currentUser && (currentUser.role === 'admin' || 
                    (currentUser.username && currentUser.username.toLowerCase() === 'david_nazaryan'));
                const canEdit = window.authManager?.permissions?.canEdit || isAdmin;
                
                if (canEdit) {
                    homeworkAdd.style.display = 'block';
                    
                    addBtn.onclick = () => {
                        const homeworkText = prompt('Введите домашнее задание:');
                        if (homeworkText && homeworkText.trim()) {
                            addLessonHomework(lessonId, homeworkText.trim());
                        }
                    };
                } else {
                    homeworkAdd.style.display = 'none';
                }
            }
        }

        function hideHomeworkSection() {
            const modal = document.getElementById('pair-modal');
            const homeworkDisplay = modal.querySelector('.pair-homework-display');
            const homeworkAdd = modal.querySelector('.pair-homework-add');
            
            if (homeworkDisplay && homeworkAdd) {
                homeworkDisplay.style.display = 'none';
                homeworkAdd.style.display = 'none';
            }
        }

        async function addLessonHomework(lessonId, homeworkText) {
            try {
                const initData = window.Telegram?.WebApp?.initData || '';
                const currentUser = window.authManager?.currentUser;
                
                if (!currentUser || !currentUser.group_id) {
                    alert('Ошибка: нет данных пользователя');
                    return;
                }

                const formData = new FormData();
                formData.append('lesson_id', lessonId);
                formData.append('homework_text', homeworkText);
                formData.append('group_id', currentUser.group_id);
                if (initData) {
                    formData.append('init_data', initData);
                }

                const response = await fetch('/api/schedule/homework', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showHomeworkInModal(homeworkText, lessonId);
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (error) {
                console.error('Ошибка добавления домашнего задания:', error);
                alert('Ошибка: ' + error.message);
            }
        }

        async function updateLessonHomework(lessonId, homeworkText) {
            try {
                const initData = window.Telegram?.WebApp?.initData || '';
                const currentUser = window.authManager?.currentUser;
                
                if (!currentUser || !currentUser.group_id) {
                    alert('Ошибка: нет данных пользователя');
                    return;
                }

                const formData = new FormData();
                formData.append('lesson_id', lessonId);
                formData.append('homework_text', homeworkText);
                formData.append('group_id', currentUser.group_id);
                if (initData) {
                    formData.append('init_data', initData);
                }

                const response = await fetch('/api/schedule/homework', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showHomeworkInModal(homeworkText, lessonId);
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (error) {
                console.error('Ошибка обновления домашнего задания:', error);
                alert('Ошибка: ' + error.message);
            }
        }

        async function deleteLessonHomework(lessonId) {
            try {
                const initData = window.Telegram?.WebApp?.initData || '';
                const currentUser = window.authManager?.currentUser;
                
                if (!currentUser || !currentUser.group_id) {
                    alert('Ошибка: нет данных пользователя');
                    return;
                }

                const formData = new FormData();
                formData.append('lesson_id', lessonId);
                formData.append('group_id', currentUser.group_id);
                if (initData) {
                    formData.append('init_data', initData);
                }

                const response = await fetch('/api/schedule/homework', {
                    method: 'DELETE',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showAddHomeworkButton(lessonId);
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (error) {
                console.error('Ошибка удаления домашнего задания:', error);
                alert('Ошибка: ' + error.message);
            }
        }

        function groupLessonsByDate(lessons) {
            const byDate = new Map();
            lessons.forEach(lesson => {
                if (!lesson.date) {
                    return;
                }
                if (!byDate.has(lesson.date)) {
                    byDate.set(lesson.date, []);
                }
                byDate.get(lesson.date).push(lesson);
            });
            return Array.from(byDate.entries()).sort((a, b) => parseRussianDate(a[0]) - parseRussianDate(b[0]));
        }

        function buildPairMap(dayLessons) {
            const pairMap = new Map();
            const extras = [];
            dayLessons.forEach(lesson => {
                const pairNo = Number.parseInt(lesson.pair_number, 10);
                if (Number.isFinite(pairNo) && pairNo > 0) {
                    if (!pairMap.has(pairNo)) {
                        pairMap.set(pairNo, []);
                    }
                    pairMap.get(pairNo).push(lesson);
                } else {
                    extras.push(lesson);
                }
            });
            pairMap.forEach(list => list.sort((a, b) => (a.starts_at || '').localeCompare(b.starts_at || '')));
            extras.sort((a, b) => (a.starts_at || '').localeCompare(b.starts_at || ''));
            return { pairMap, extras };
        }

        function compareLessons(a, b) {
            const dateDiff = parseRussianDate(a.date).getTime() - parseRussianDate(b.date).getTime();
            if (dateDiff !== 0) {
                return dateDiff;
            }
            const pairA = Number.isFinite(Number(a.pair_number)) ? Number(a.pair_number) : 999;
            const pairB = Number.isFinite(Number(b.pair_number)) ? Number(b.pair_number) : 999;
            if (pairA !== pairB) {
                return pairA - pairB;
            }
            return (a.starts_at || '').localeCompare(b.starts_at || '');
        }

        function formatDateHuman(value) {
            const date = parseRussianDate(value);
            const day = date.getDate();
            const month = MONTHS[date.getMonth()];
            // Принудительно используем 2025 год
            const year = 2025;
            const weekday = WEEKDAYS[date.getDay()];
            const capitalizedWeekday = weekday.charAt(0).toUpperCase() + weekday.slice(1);
            return `${day} ${month} ${year}, ${capitalizedWeekday}`;
        }

        function formatTimeRange(start, end) {
            if (!start && !end) return '';
            if (!start || !end) return start || end;
            return `${start} — ${end}`;
        }

        function parseRussianDate(value) {
            if (!value || typeof value !== 'string') {
                return new Date(0);
            }
            const [day, month, year] = value.split('.').map(Number);
            return new Date(year, (month || 1) - 1, day || 1);
        }

        function formatDateInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseInputDate(value) {
            const [year, month, day] = value.split('-').map(Number);
            return new Date(year, (month || 1) - 1, day || 1);
        }


        function addDays(date, amount) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return new Date(); // Fallback to current date
            }
            const result = new Date(date.getTime() + amount * 24 * 60 * 60 * 1000);
            return result;
        }

        // Ensure weekly view shows today's schedule once data is available
        function refreshWeeklySelectionAfterData() {
            if (!weeklyDateSelector) return;
            if (!weeklyDateSelector.children.length) {
                renderWeeklyDateSelector(true);
            }
            
            // First, try to navigate to today's week if it's not currently displayed
            const today = new Date();
            const todayWeekMonday = getMonday(today);
            const todayStr = formatAPIDate(today);
            
            // Check if today is in the currently displayed week
            const todayBtn = Array.from(weeklyDateSelector.querySelectorAll('button'))
                .find(b => b.dataset.date === todayStr);
            
            if (!todayBtn) {
                // Today is not in current week, navigate to today's week
                currentWeekMonday = todayWeekMonday;
                renderWeeklyDateSelector(true);
            }
            
            // Preserve current selection if it exists and has data
            if (currentlySelectedDate) {
                const hasData = aggregatedLessons.some(l => {
                    const lessonDate = l.date;
                    if (!lessonDate) return false;
                    if (lessonDate.includes('-')) return lessonDate === currentlySelectedDate;
                    const [day, month, year] = lessonDate.split('.');
                    const formatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    return formatted === currentlySelectedDate;
                });
                
                if (hasData) {
                    const targetBtn = Array.from(weeklyDateSelector.querySelectorAll('button'))
                        .find(b => b.dataset.date === currentlySelectedDate);
                    if (targetBtn) {
                        selectWeeklyDate(targetBtn.dataset.date, targetBtn);
                        return;
                    }
                }
            }
            
            // Try to select today's date if it has data
            const todayHasData = aggregatedLessons.some(l => {
                const lessonDate = l.date;
                if (!lessonDate) return false;
                if (lessonDate.includes('-')) return lessonDate === todayStr;
                const [day, month, year] = lessonDate.split('.');
                const formatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                return formatted === todayStr;
            });
            
            if (todayHasData) {
                const todayBtn = Array.from(weeklyDateSelector.querySelectorAll('button'))
                    .find(b => b.dataset.date === todayStr);
                if (todayBtn) {
                    selectWeeklyDate(todayBtn.dataset.date, todayBtn);
                    return;
                }
            }
            
            // Use synchronized week state to determine which day to select
            let targetDateStr;
            // Find the first day of the current synchronized week that has data
            const weekStart = new Date(currentWeekMonday);
            for (let i = 0; i < 6; i++) {
                const checkDate = addDays(weekStart, i);
                const checkDateStr = formatAPIDate(checkDate);
                const hasData = aggregatedLessons.some(l => {
                    const lessonDate = l.date;
                    if (!lessonDate) return false;
                    if (lessonDate.includes('-')) return lessonDate === checkDateStr;
                    const [day, month, year] = lessonDate.split('.');
                    const formatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    return formatted === checkDateStr;
                });
                if (hasData) {
                    targetDateStr = checkDateStr;
                    break;
                }
            }
            
            // Fallback to today or first available day
            if (!targetDateStr) {
                const todayBtn = Array.from(weeklyDateSelector.querySelectorAll('button')).find(b => b.dataset.date === todayStr);
                targetDateStr = todayBtn ? todayBtn.dataset.date : weeklyDateSelector.querySelector('button')?.dataset.date;
            }
            
            if (targetDateStr) {
                const targetBtn = Array.from(weeklyDateSelector.querySelectorAll('button')).find(b => b.dataset.date === targetDateStr);
                if (targetBtn) selectWeeklyDate(targetBtn.dataset.date, targetBtn);
            }
        }

        // --- Swipe handling for weekly date selector ---
        (function initWeeklySwipe() {
            if (!weeklyDateSelector) return;
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            const SWIPE_THRESHOLD = 50; // px
            const VERTICAL_TOLERANCE = 30; // px

            function onTouchStart(e) {
                const t = e.changedTouches ? e.changedTouches[0] : null;
                if (!t) return;
                touchStartX = t.clientX;
                touchStartY = t.clientY;
                touchEndX = touchStartX;
                touchEndY = touchStartY;
            }
            function onTouchMove(e) {
                const t = e.changedTouches ? e.changedTouches[0] : null;
                if (!t) return;
                touchEndX = t.clientX;
                touchEndY = t.clientY;
            }
            async function onTouchEnd() {
                const dx = touchEndX - touchStartX;
                const dy = touchEndY - touchStartY;
                if (Math.abs(dy) > VERTICAL_TOLERANCE) return; // ignore mostly vertical
                if (Math.abs(dx) < SWIPE_THRESHOLD) return; // too short
                
                // Calculate relative day position in current week
                let relativeDayIndex = 0;
                if (currentlySelectedDate) {
                    const selectedDate = parseInputDate(currentlySelectedDate);
                    const weekStart = new Date(currentWeekMonday);
                    const diffInMs = selectedDate.getTime() - weekStart.getTime();
                    relativeDayIndex = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
                    relativeDayIndex = Math.max(0, Math.min(5, relativeDayIndex)); // Clamp to 0-5 (Mon-Sat)
                }
                
                // Always allow swipe in weekly mode
                if (dx < 0) {
                    // swipe left → next week
                    currentWeekMonday = addDays(currentWeekMonday, 7);
                    
                    // Add swipe animation
                    weeklyDateSelector.classList.add('swipe-left');
                    setTimeout(() => {
                        weeklyDateSelector.classList.remove('swipe-left');
                    }, 350); // Adjusted timeout for faster animation
                    
                    // Try to select today's date in the new week, otherwise preserve relative position
                    const todayStr = formatAPIDate(new Date());
                    const todayBtn = Array.from(weeklyDateSelector.querySelectorAll('button'))
                        .find(b => b.dataset.date === todayStr);
                    
                    if (todayBtn) {
                        // If today is in the new week, select it
                        currentlySelectedDate = todayStr;
                    } else if (currentlySelectedDate && relativeDayIndex >= 0 && relativeDayIndex <= 5) {
                        // Otherwise preserve relative position
                        const newWeekStart = new Date(currentWeekMonday);
                        const newSelectedDate = addDays(newWeekStart, relativeDayIndex);
                        currentlySelectedDate = formatAPIDate(newSelectedDate);
                    }
                    
                    renderWeeklyDateSelector(true); // Preserve selection
                } else {
                    // swipe right → previous week
                    currentWeekMonday = addDays(currentWeekMonday, -7);
                    
                    // Add swipe animation
                    weeklyDateSelector.classList.add('swipe-right');
                    setTimeout(() => {
                        weeklyDateSelector.classList.remove('swipe-right');
                    }, 350); // Adjusted timeout for faster animation
                    
                    // Try to select today's date in the new week, otherwise preserve relative position
                    const todayStr = formatAPIDate(new Date());
                    const todayBtn = Array.from(weeklyDateSelector.querySelectorAll('button'))
                        .find(b => b.dataset.date === todayStr);
                    
                    if (todayBtn) {
                        // If today is in the new week, select it
                        currentlySelectedDate = todayStr;
                    } else if (currentlySelectedDate && relativeDayIndex >= 0 && relativeDayIndex <= 5) {
                        // Otherwise preserve relative position
                        const newWeekStart = new Date(currentWeekMonday);
                        const newSelectedDate = addDays(newWeekStart, relativeDayIndex);
                        currentlySelectedDate = formatAPIDate(newSelectedDate);
                    }
                    
                    renderWeeklyDateSelector(true); // Preserve selection
                }
                
                // Always update today highlighting after swipe
                setTimeout(() => {
                    updateTodayHighlighting();
                }, 50);
            }
            weeklyDateSelector.addEventListener('touchstart', onTouchStart, { passive: true });
            weeklyDateSelector.addEventListener('touchmove', onTouchMove, { passive: true });
            weeklyDateSelector.addEventListener('touchend', onTouchEnd, { passive: true });
        })();

        // --- Week Navigation Event Handlers ---
        (function initWeekNavigation() {
            if (!prevWeekBtn || !nextWeekBtn) return;
            
            // Helper function to reset button state
            function resetButtonState(button) {
                // Remove any lingering focus/active states
                button.blur();
                
                // Force reset transform after a short delay
                setTimeout(() => {
                    button.style.transform = '';
                }, 150);
            }
            
            prevWeekBtn.addEventListener('click', function(e) {
                goToPreviousWeek();
                resetButtonState(this);
            });
            
            nextWeekBtn.addEventListener('click', function(e) {
                goToNextWeek();
                resetButtonState(this);
            });
            
            // Also handle touch events for mobile
            prevWeekBtn.addEventListener('touchend', function(e) {
                setTimeout(() => resetButtonState(this), 100);
            });
            
            nextWeekBtn.addEventListener('touchend', function(e) {
                setTimeout(() => resetButtonState(this), 100);
            });
        })();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopCurrentPairUpdates();
        });

        // Система аутентификации и управления пользователями
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.permissions = {
                    canView: false,
                    canEdit: false
                };
                // Небольшая задержка для загрузки Telegram API
                setTimeout(() => {
                    this.init();
                }, 100);
            }
            
            async init() {
                console.log('🚀 Инициализация AuthManager для продакшена...');
                
                // Проверяем доступность Telegram WebApp API
                if (!window.Telegram?.WebApp) {
                    console.error('❌ Telegram WebApp API недоступен');
                    this.showError('Приложение должно быть запущено в Telegram');
                    return;
                }
                
                const webApp = window.Telegram.WebApp;
                console.log('✅ Telegram WebApp API найден');
                console.log('📊 WebApp данные:', {
                    initData: webApp.initData ? 'Доступен' : 'Отсутствует',
                    initDataUnsafe: webApp.initDataUnsafe ? 'Доступен' : 'Отсутствует',
                    version: webApp.version
                });
                
                // Инициализируем WebApp
                webApp.ready();
                webApp.expand();
                
                // Определяем высоту кнопок управления Telegram
                this.updateTelegramControlsHeight();
                
                // Выполняем аутентификацию
                    await this.authenticateWithTelegram();
            }
            
            async authenticateWithTelegram() {
                const webApp = window.Telegram.WebApp;
                
                try {
                    console.log('🔐 Начинаем аутентификацию пользователя...');
                    
                    // Сначала пытаемся получить данные пользователя из initDataUnsafe
                    if (webApp.initDataUnsafe?.user) {
                        console.log('✅ Найдены данные пользователя в initDataUnsafe');
                        const telegramUser = webApp.initDataUnsafe.user;
                        console.log('👤 Пользователь:', {
                            id: telegramUser.id,
                            first_name: telegramUser.first_name,
                            username: telegramUser.username
                        });
                        
                        // Создаем пользователя локально
                        await this.createUserFromTelegramData(telegramUser);
                        return;
                    }
                    
                    // Если initDataUnsafe недоступен, пытаемся использовать initData для серверной аутентификации
                    if (webApp.initData) {
                        console.log('🔑 initData доступен, отправляем на сервер для аутентификации');
                        const serverUser = await this.authenticateWithServer(webApp.initData);
                        this.setAuthenticatedUser(serverUser);
                        return;
                    }
                    
                    // Если ничего не доступно - ошибка
                    throw new Error('Данные пользователя недоступны в Telegram WebApp');
                    
                } catch (error) {
                    console.error('❌ Ошибка аутентификации:', error);
                    this.showError(`Ошибка аутентификации: ${error.message}`);
                }
            }
            
            setAuthenticatedUser(user, options = {}) {
                const { notify = true, message } = options;
                
                this.currentUser = user;
                this.permissions = {
                    canView: true,
                    canEdit: user.role === 'monitor' || user.role === 'admin'
                };
                
                this.updateUI();
                
                setTimeout(() => {
                    this.updatePermissionBasedUI();
                }, 100);
                
                if (notify) {
                    const text = message || `Добро пожаловать, ${user.first_name}!`;
                    this.showNotification(text, 'success');
                }
            }
            
            async createUserFromTelegramData(telegramUser) {
                console.log('👤 Создаем пользователя из данных Telegram...');
                
                const user = {
                    id: telegramUser.id,
                    first_name: telegramUser.first_name,
                    last_name: telegramUser.last_name || '',
                    username: telegramUser.username || '',
                    photo_url: telegramUser.photo_url || '',
                    language_code: telegramUser.language_code || 'ru',
                    role: "student", // По умолчанию все новые пользователи - студенты
                    group_id: this.getGroupIdFromUrl(),
                    status: "active",
                    created_at: new Date().toISOString(),
                    last_seen: new Date().toISOString()
                };
                
                console.log('✅ Пользователь создан локально:', user);
                
                this.setAuthenticatedUser(user, { notify: false });
                this.showNotification(`Добро пожаловать, ${user.first_name}!`, 'success');
                
                const initData = window.Telegram?.WebApp?.initData;
                
                if (initData) {
                    try {
                        const serverUser = await this.authenticateWithServer(initData);
                        if (serverUser) {
                            console.log('🔁 Пользователь подтвержден сервером:', serverUser);
                            this.setAuthenticatedUser(serverUser, { notify: false });
                        }
                    } catch (error) {
                        console.warn('⚠️ Не удалось подтвердить пользователя на сервере:', error);
                        this.showNotification('Не удалось подтвердить вход на сервере. Некоторые функции могут быть недоступны.', 'warning');
                    }
                } else {
                    console.warn('⚠️ initData недоступен, серверная аутентификация пропущена.');
                }
            }
            
            async authenticateWithServer(initData) {
                console.log('🌐 Аутентификация через сервер...');
                
                try {
                    const formData = new FormData();
                    formData.append('init_data', initData);
                    
                    const groupId = this.getGroupIdFromUrl();
                    if (groupId) {
                        formData.append('group_id', groupId);
                    }
                    
                    const response = await fetch('/api/auth/telegram', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Сервер вернул ошибку: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Неизвестная ошибка сервера');
                    }
                    
                    console.log('✅ Серверная аутентификация успешна');
                    return result.user;
                } catch (error) {
                    console.error('❌ Ошибка серверной аутентификации:', error);
                    throw error;
                }
            }
            
            showError(message) {
                console.error('🚨 Ошибка:', message);
                
                // Показываем ошибку пользователю
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #ff4757;
                    color: white;
                    padding: 20px;
                    border-radius: 8px;
                    text-align: center;
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                `;
                errorDiv.innerHTML = `
                    <h3>Ошибка</h3>
                    <p>${message}</p>
                    <p>Приложение должно быть запущено в Telegram</p>
                `;
                
                document.body.appendChild(errorDiv);
                
                // Убираем через 5 секунд
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
            
            getGroupIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                let groupId = urlParams.get('group_id');
                
                // Если group_id не найден, попробуем извлечь из tgWebAppStartParam
                if (!groupId) {
                    const startParam = urlParams.get('tgWebAppStartParam');
                    console.log('tgWebAppStartParam:', startParam);
                    
                    if (startParam) {
                        // Если startParam содержит group_id, извлекаем его
                        if (startParam.includes('group_id=')) {
                            const match = startParam.match(/group_id=([^&]+)/);
                            if (match) {
                                groupId = match[1];
                                console.log('Извлечен group_id из tgWebAppStartParam:', groupId);
                            }
                        }
                    }
                }
                
                console.log('Итоговый group_id:', groupId);
                return groupId;
            }
            
            async loadPermissions() {
                if (!this.currentUser || !this.currentUser.group_id) return;
                
                try {
                    const response = await fetch(`/api/schedule/${this.currentUser.group_id}/permissions`);
                    if (response.ok) {
                        this.permissions = await response.json();
                        this.updateUI();
                    }
                } catch (error) {
                    console.error('Ошибка загрузки прав доступа:', error);
                }
            }
            
            showNotification(message, type = 'info') {
                // Создаем уведомление
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                
                // Стили для уведомления
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    max-width: 300px;
                    word-wrap: break-word;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    transition: all 0.3s ease;
                `;
                
                // Цвета в зависимости от типа
                switch(type) {
                    case 'success':
                        notification.style.backgroundColor = '#4CAF50';
                        break;
                    case 'error':
                        notification.style.backgroundColor = '#f44336';
                        break;
                    case 'warning':
                        notification.style.backgroundColor = '#ff9800';
                        break;
                    default:
                        notification.style.backgroundColor = '#2196F3';
                }
                
                // Добавляем в DOM
                document.body.appendChild(notification);
                
                // Автоматически удаляем через 5 секунд
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }
                }, 5000);
            }

            updateUI() {
                console.log('updateUI вызвана, currentUser:', this.currentUser);
                
                // Обновляем отображение пользователя в настройках
                const userInfo = document.getElementById('user-info');
                console.log('userInfo элемент:', userInfo);
                
                if (userInfo && this.currentUser) {
                    console.log('Обновляем информацию о пользователе');
                    userInfo.innerHTML = `
                        <div class="user-avatar-settings">
                            ${this.currentUser.photo_url ? 
                                `<img src="${this.currentUser.photo_url}" alt="Аватар">` : 
                                `${this.currentUser.first_name[0]}`
                            }
                        </div>
                        <div class="user-details-settings">
                            <div class="user-name-settings">${this.currentUser.first_name} ${this.currentUser.last_name || ''}</div>
                            <div class="user-role-settings">${this.getRoleDisplayName(this.currentUser.role)}</div>
                            <div class="user-id-settings">ID: ${this.currentUser.id}</div>
                            ${this.currentUser.group_id ? `<div class="user-group-settings">Группа: ${this.currentUser.group_id}</div>` : ''}
                        </div>
                    `;
                    userInfo.style.display = 'flex';
                    console.log('Информация о пользователе обновлена');
                } else {
                    console.log('Не удалось обновить информацию о пользователе:', {
                        userInfo: !!userInfo,
                        currentUser: !!this.currentUser
                    });
                }
                
                // Показываем кнопку выхода
                const userActions = document.getElementById('user-actions');
                if (userActions && this.currentUser) {
                    userActions.style.display = 'block';
                }
                
                // Показываем панель администратора
                const adminPanel = document.getElementById('admin-panel');
                if (adminPanel && this.currentUser) {
                    const isAdmin = this.currentUser.role === 'admin' || 
                        (this.currentUser.username && this.currentUser.username.toLowerCase() === 'david_nazaryan');
                    adminPanel.style.display = isAdmin ? 'block' : 'none';
                }
                
                // Показываем/скрываем элементы в зависимости от прав
                this.updatePermissionBasedUI();
            }
            
            getRoleDisplayName(role) {
                const roleNames = {
                    'student': 'Студент',
                    'monitor': 'Староста',
                    'admin': 'Администратор',
                    'guest': 'Гость'
                };
                return roleNames[role] || 'Пользователь';
            }
            
            updatePermissionBasedUI() {
                console.log('Updating permission-based UI...', {
                    canEdit: this.permissions.canEdit,
                    currentUser: this.currentUser
                });
                
                // Проверяем, является ли пользователь администратором
                const isAdmin = this.currentUser && (this.currentUser.role === 'admin' || 
                    (this.currentUser.username && this.currentUser.username.toLowerCase() === 'david_nazaryan'));
                
                // Показываем/скрываем кнопки для добавления домашнего задания в карточках пар
                const homeworkButtons = document.querySelectorAll('.add-homework-btn');
                console.log('Found homework buttons:', homeworkButtons.length);
                
                homeworkButtons.forEach((btn, index) => {
                    // Показываем кнопки только для пользователей с правами редактирования (старосты и админы)
                    if (this.permissions.canEdit || isAdmin) {
                        btn.style.display = 'block';
                        console.log(`Button ${index}: shown (user has edit permissions)`);
                    } else {
                        btn.style.display = 'none';
                        console.log(`Button ${index}: hidden (no edit permissions)`);
                    }
                });
                
                // Показываем панель управления пользователями старостам и админам
                const userManagementPanel = document.getElementById('user-management-panel');
                if (userManagementPanel) {
                    userManagementPanel.style.display = (this.permissions.canEdit || isAdmin) ? 'block' : 'none';
                }
                
                // Загружаем домашние задания для группы
                this.loadGroupHomework();
            }
            
            
            async loadGroupHomework() {
                if (!this.currentUser || !this.currentUser.group_id) {
                    console.log('No group ID available for loading homework');
                    return;
                }
                
                try {
                    const initData = window.Telegram?.WebApp?.initData || '';
                    
                    const response = await fetch(`/api/schedule/homework/${this.currentUser.group_id}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        ...(initData && {
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Telegram-Init-Data': initData
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        console.error('Failed to load homework:', response.status);
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (result.success && result.homework_tasks) {
                        console.log('Loaded homework tasks:', result.homework_tasks);
                        this.displayLoadedHomework(result.homework_tasks);
                    }
                } catch (error) {
                    console.error('Error loading homework:', error);
                }
            }
            
            displayLoadedHomework(homeworkTasks) {
                homeworkTasks.forEach(homework => {
                    const homeworkButton = document.querySelector(`[data-lesson-id="${homework.lesson_id}"]`);
                    if (homeworkButton) {
                        // Скрываем кнопку добавления
                        homeworkButton.style.display = 'none';
                        
                        // Добавляем отображение домашнего задания
                        this.updateHomeworkDisplay(homework.lesson_id, homework.homework_text);
                    }
                });
            }

            showAuthError(message) {
                alert('Ошибка аутентификации: ' + message);
            }
            
            async addHomework(lessonId, homeworkText) {
                if (!this.permissions.canEdit) {
                    alert('У вас нет прав для добавления домашнего задания');
                    return;
                }
                
                try {
                    // Получаем данные аутентификации
                    const initData = window.Telegram?.WebApp?.initData || '';
                    
                    const formData = new FormData();
                    formData.append('lesson_id', lessonId);
                    formData.append('homework_text', homeworkText);
                    formData.append('group_id', this.currentUser.group_id);
                    if (initData) {
                        formData.append('init_data', initData);
                    }
                    
                    const response = await fetch('/api/schedule/homework', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Ошибка сервера:', response.status, errorText);
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Домашнее задание добавлено');
                        // Обновляем интерфейс
                        this.updateHomeworkDisplay(lessonId, homeworkText);
                    } else {
                        alert('Ошибка: ' + result.message);
                    }
                } catch (error) {
                    console.error('Ошибка добавления домашнего задания:', error);
                    alert('Ошибка: ' + error.message);
                }
            }
            
            updateHomeworkDisplay(lessonId, homeworkText) {
                // Находим кнопку домашнего задания и добавляем отображение
                const homeworkButton = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                if (homeworkButton) {
                    // Находим родительскую карточку пары
                    const pairCard = homeworkButton.closest('.pair-card');
                    if (pairCard) {
                        // Удаляем старое домашнее задание, если есть
                        const oldHomework = pairCard.querySelector('.homework-display');
                        if (oldHomework) {
                            oldHomework.remove();
                        }
                        
                        // Создаем новый блок с домашним заданием
                        const homeworkDiv = document.createElement('div');
                        homeworkDiv.className = 'homework-display';
                        homeworkDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">
                                <div style="flex: 1;">
                                    <strong>📝 Домашнее задание:</strong> ${homeworkText}
                                </div>
                                <div style="display: flex; gap: 0.25rem;">
                                    <button class="edit-homework-btn" style="
                                        background: none;
                                        border: none;
                                        color: var(--accent);
                                        cursor: pointer;
                                        padding: 0.25rem;
                                        border-radius: 4px;
                                        font-size: 0.8rem;
                                        opacity: 0.7;
                                        transition: opacity 0.2s ease;
                                    " title="Редактировать">✏️</button>
                                    <button class="delete-homework-btn" style="
                                        background: none;
                                        border: none;
                                        color: #dc2626;
                                        cursor: pointer;
                                        padding: 0.25rem;
                                        border-radius: 4px;
                                        font-size: 0.8rem;
                                        opacity: 0.7;
                                        transition: opacity 0.2s ease;
                                    " title="Удалить">🗑️</button>
                                </div>
                            </div>
                        `;
                        
                        // Добавляем обработчик для кнопки редактирования
                        const editBtn = homeworkDiv.querySelector('.edit-homework-btn');
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const newText = prompt('Редактировать домашнее задание:', homeworkText);
                            if (newText && newText.trim() && newText.trim() !== homeworkText) {
                                this.addHomework(lessonId, newText.trim());
                            }
                        });
                        
                        editBtn.addEventListener('mouseenter', () => {
                            editBtn.style.opacity = '1';
                        });
                        
                        editBtn.addEventListener('mouseleave', () => {
                            editBtn.style.opacity = '0.7';
                        });
                        
                        // Добавляем обработчик для кнопки удаления
                        const deleteBtn = homeworkDiv.querySelector('.delete-homework-btn');
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm('Удалить домашнее задание?')) {
                                authManager.deleteHomework(lessonId);
                            }
                        });
                        
                        deleteBtn.addEventListener('mouseenter', () => {
                            deleteBtn.style.opacity = '1';
                        });
                        
                        deleteBtn.addEventListener('mouseleave', () => {
                            deleteBtn.style.opacity = '0.7';
                        });
                        
                        // Вставляем после кнопки
                        homeworkButton.parentNode.insertBefore(homeworkDiv, homeworkButton.nextSibling);
                        
                        // Скрываем кнопку, так как задание уже добавлено
                        homeworkButton.style.display = 'none';
                    }
                }
            }
            
            showHomeworkModal(lessonId, subject) {
                // Проверяем права пользователя
                const isAdmin = this.currentUser && (this.currentUser.role === 'admin' || 
                    (this.currentUser.username && this.currentUser.username.toLowerCase() === 'david_nazaryan'));
                const canEdit = this.permissions.canEdit || isAdmin;
                
                if (!canEdit) {
                    alert('У вас нет прав для добавления домашнего задания');
                    return;
                }
                
                const homeworkText = prompt(`Добавить домашнее задание для "${subject}":`);
                if (homeworkText && homeworkText.trim()) {
                    this.addHomework(lessonId, homeworkText.trim());
                }
            }
            
            async deleteHomework(lessonId) {
                // Проверяем права пользователя
                const isAdmin = this.currentUser && (this.currentUser.role === 'admin' || 
                    (this.currentUser.username && this.currentUser.username.toLowerCase() === 'david_nazaryan'));
                const canEdit = this.permissions.canEdit || isAdmin;
                
                if (!canEdit) {
                    alert('У вас нет прав для удаления домашнего задания');
                    return;
                }
                
                try {
                    // Получаем данные аутентификации
                    const initData = window.Telegram?.WebApp?.initData || '';
                    
                    const formData = new FormData();
                    formData.append('lesson_id', lessonId);
                    formData.append('group_id', this.currentUser.group_id);
                    if (initData) {
                        formData.append('init_data', initData);
                    }
                    
                    const response = await fetch('/api/schedule/homework', {
                        method: 'DELETE',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Ошибка сервера:', response.status, errorText);
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Удаляем отображение домашнего задания
                        const homeworkButton = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                        if (homeworkButton) {
                            const pairCard = homeworkButton.closest('.pair-card');
                            if (pairCard) {
                                const homeworkDiv = pairCard.querySelector('.homework-display');
                                if (homeworkDiv) {
                                    homeworkDiv.remove();
                                }
                                homeworkButton.style.display = 'block';
                            }
                        }
                    } else {
                        alert('Ошибка: ' + result.message);
                    }
                } catch (error) {
                    console.error('Ошибка удаления домашнего задания:', error);
                    alert('Ошибка: ' + error.message);
                }
            }
            
            // Функции для управления пользователями
            showUserManagementModal() {
                if (!this.permissions.canEdit) {
                    alert('У вас нет прав для управления пользователями');
                    return;
                }
                
                const modal = document.getElementById('user-management-modal');
                modal.classList.add('show');
                this.loadGroupUsers();
            }
            
            closeUserManagementModal() {
                const modal = document.getElementById('user-management-modal');
                modal.classList.remove('show');
            }
            
            async loadGroupUsers() {
                if (!this.currentUser || !this.currentUser.group_id) {
                    console.error('Нет информации о группе пользователя');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/groups/${this.currentUser.group_id}/users`);
                    if (response.ok) {
                        const responseText = await response.text();
                        console.log('Ответ сервера (raw):', responseText);
                        
                        try {
                            const users = JSON.parse(responseText);
                            console.log('Распарсенные пользователи:', users);
                            this.renderUserList(users);
                        } catch (jsonError) {
                            console.error('Ошибка парсинга JSON:', jsonError);
                            console.error('Проблемный JSON:', responseText);
                            this.showNotification('Ошибка загрузки данных пользователей', 'error');
                        }
                    } else {
                        console.error('Ошибка загрузки пользователей:', response.status);
                        const errorText = await response.text();
                        console.error('Текст ошибки:', errorText);
                        this.showNotification(`Ошибка сервера: ${response.status}`, 'error');
                    }
                } catch (error) {
                    console.error('Ошибка загрузки пользователей:', error);
                    this.showNotification('Ошибка подключения к серверу', 'error');
                }
            }
            
            renderUserList(users) {
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';
                
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar-small">${user.first_name[0]}</div>
                            <div class="user-details-small">
                                <div class="user-name-small">${user.first_name} ${user.last_name || ''}</div>
                                <div class="user-role-small">${this.getRoleDisplayName(user.role)}</div>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="role-btn ${user.role}" onclick="authManager.changeUserRole(${user.id}, '${user.role === 'monitor' ? 'student' : 'monitor'}')">
                                ${user.role === 'monitor' ? 'Сделать студентом' : 'Сделать старостой'}
                            </button>
                        </div>
                    `;
                    userList.appendChild(userItem);
                });
            }
            
            async changeUserRole(userId, newRole) {
                // Проверяем права пользователя
                const isAdmin = this.currentUser && (this.currentUser.role === 'admin' || 
                    (this.currentUser.username && this.currentUser.username.toLowerCase() === 'david_nazaryan'));
                const canEdit = this.permissions.canEdit || isAdmin;
                
                if (!canEdit) {
                    alert('У вас нет прав для изменения ролей');
                    return;
                }
                
                try {
                    const initData = window.Telegram?.WebApp?.initData || '';
                    
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('role', newRole);
                    formData.append('group_id', this.currentUser.group_id);
                    if (initData) {
                        formData.append('init_data', initData);
                    }
                    
                    const response = await fetch('/api/users/role', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Роль пользователя изменена');
                        this.loadGroupUsers(); // Перезагружаем список
                    } else {
                        alert('Ошибка: ' + result.message);
                    }
                } catch (error) {
                    console.error('Ошибка изменения роли:', error);
                    alert('Ошибка: ' + error.message);
                }
            }
            
            async addUserToGroup() {
                const userIdInput = document.getElementById('user-id-input');
                const roleSelect = document.getElementById('user-role-select');
                
                const userId = userIdInput.value.trim();
                const role = roleSelect.value;
                
                if (!userId) {
                    alert('Введите ID пользователя');
                    return;
                }
                
                try {
                    const initData = window.Telegram?.WebApp?.initData || '';
                    
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('role', role);
                    formData.append('group_id', this.currentUser.group_id);
                    if (initData) {
                        formData.append('init_data', initData);
                    }
                    
                    const response = await fetch('/api/users/role', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Пользователь добавлен в группу');
                        userIdInput.value = '';
                        this.loadGroupUsers(); // Перезагружаем список
                    } else {
                        alert('Ошибка: ' + result.message);
                    }
                } catch (error) {
                    console.error('Ошибка добавления пользователя:', error);
                    alert('Ошибка: ' + error.message);
                }
            }
            
            // Функция выхода из аккаунта
            logout() {
                if (confirm('Вы уверены, что хотите выйти из аккаунта?')) {
                    console.log('🚪 Выход пользователя...');
                    
                    // Очищаем данные пользователя
                    this.currentUser = null;
                    this.permissions = {
                        canView: false,
                        canEdit: false
                    };
                    
                    // Скрываем элементы пользователя
                    const userInfo = document.getElementById('user-info');
                    const userActions = document.getElementById('user-actions');
                    const userManagementPanel = document.getElementById('user-management-panel');
                    const adminPanel = document.getElementById('admin-panel');
                    
                    if (userInfo) userInfo.style.display = 'none';
                    if (userActions) userActions.style.display = 'none';
                    if (userManagementPanel) userManagementPanel.style.display = 'none';
                    if (adminPanel) adminPanel.style.display = 'none';
                    
                    // Скрываем кнопки домашнего задания
                    this.updatePermissionBasedUI();
                    
                    // В Telegram WebApp показываем уведомление
                    this.showNotification('Вы вышли из аккаунта. Перезапустите приложение для повторного входа.', 'info');
                    
                    // Переключаемся на вкладку расписания
                    const scheduleTab = document.getElementById('tab-schedule');
                    if (scheduleTab) {
                        scheduleTab.click();
                    }
                }
            }
            
            // Функция для определения высоты кнопок управления Telegram
            updateTelegramControlsHeight() {
                try {
                    const webApp = window.Telegram?.WebApp;
                    if (!webApp) {
                        console.log('📱 Telegram WebApp недоступен, используем стандартную высоту');
                        return;
                    }
                    
                    // Получаем информацию о viewport
                    const viewportHeight = webApp.viewportHeight || window.innerHeight;
                    const viewportStableHeight = webApp.viewportStableHeight || window.innerHeight;
                    
                    console.log('📱 Telegram viewport данные:', {
                        viewportHeight,
                        viewportStableHeight,
                        difference: viewportHeight - viewportStableHeight
                    });
                    
                    // Вычисляем высоту кнопок управления
                    const controlsHeight = Math.max(0, viewportHeight - viewportStableHeight);
                    
                    // Обновляем CSS переменную
                    document.documentElement.style.setProperty('--tg-controls-height', `${controlsHeight}px`);
                    
                    console.log(`📱 Высота кнопок управления Telegram: ${controlsHeight}px`);
                    
                } catch (error) {
                    console.warn('⚠️ Ошибка при определении высоты кнопок управления:', error);
                    // Используем стандартную высоту
                    document.documentElement.style.setProperty('--tg-controls-height', '44px');
                }
            }
            
            // Функция для управления всеми группами
            async manageAllGroups() {
                try {
                    const initData = window.Telegram?.WebApp?.initData || '';
                    
                    const response = await fetch('/api/admin/groups', {
                        method: 'GET',
                        headers: {
                            'X-Telegram-Init-Data': initData
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }
                    
                    const groups = await response.json();
                    
                    // Создаем модальное окно для отображения групп
                    this.showGroupsModal(groups);
                    
                } catch (error) {
                    console.error('Ошибка загрузки групп:', error);
                    alert('Ошибка: ' + error.message);
                }
            }
            
            // Функция для назначения старосты
            async assignMonitor() {
                const userId = prompt('Введите ID пользователя для назначения старостой:');
                if (!userId) return;
                
                const groupId = prompt('Введите ID группы:');
                if (!groupId) return;
                
                try {
                    const initData = window.Telegram?.WebApp?.initData || '';
                    
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('role', 'monitor');
                    formData.append('group_id', groupId);
                    if (initData) {
                        formData.append('init_data', initData);
                    }
                    
                    const response = await fetch('/api/users/role', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Староста успешно назначен!');
                    } else {
                        alert('Ошибка: ' + result.message);
                    }
                } catch (error) {
                    console.error('Ошибка назначения старосты:', error);
                    alert('Ошибка: ' + error.message);
                }
            }
            
            // Функция для отображения модального окна с группами
            showGroupsModal(groups) {
                const modal = document.createElement('div');
                modal.id = 'groups-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Управление группами</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="groups-list">
                                ${groups.map(group => `
                                    <div class="group-item">
                                        <div class="group-info">
                                            <h4>${group.group_name || group.group_id}</h4>
                                            <p>ID: ${group.group_id}</p>
                                            <p>Староста: ${group.monitor_user_id || 'Не назначен'}</p>
                                            <p>Студентов: ${group.student_count}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Закрытие по клику на overlay
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }
        
        // Инициализируем менеджер аутентификации
        const authManager = new AuthManager();

        // Менеджер новостей
        class NewsManager {
            constructor() {
                this.currentPage = 1;
                this.hasMore = true;
                this.isLoading = false;
                this.searchQuery = '';
                this.searchTimeout = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Поиск новостей в заголовке
                const searchToggle = document.getElementById('news-search-toggle');
                const searchDropdown = document.getElementById('news-search-dropdown');
                const searchInput = document.getElementById('news-search-input');
                const searchBtn = document.getElementById('news-search-btn');
                
                // Переключение видимости поля поиска
                if (searchToggle && searchDropdown) {
                    searchToggle.addEventListener('click', () => {
                        const isVisible = searchDropdown.style.display !== 'none';
                        if (isVisible) {
                            searchDropdown.style.display = 'none';
                        } else {
                            searchDropdown.style.display = 'block';
                            // Фокусируемся на поле ввода
                            setTimeout(() => {
                                if (searchInput) {
                                    searchInput.focus();
                                }
                            }, 100);
                        }
                    });
                }
                
                // Поиск по вводу
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        clearTimeout(this.searchTimeout);
                        this.searchTimeout = setTimeout(() => {
                            this.searchNews(e.target.value);
                        }, 500);
                    });
                }

                // Поиск по кнопке
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        const query = searchInput ? searchInput.value : '';
                        this.searchNews(query);
                    });
                }
                
                // Закрытие поля поиска при клике вне его
                document.addEventListener('click', (e) => {
                    if (searchDropdown && searchToggle && 
                        !searchDropdown.contains(e.target) && 
                        !searchToggle.contains(e.target)) {
                        searchDropdown.style.display = 'none';
                    }
                });

                // Кнопка "Загрузить ещё"
                const loadMoreBtn = document.getElementById('news-load-more-btn');
                if (loadMoreBtn) {
                    loadMoreBtn.addEventListener('click', () => {
                        this.loadMoreNews();
                    });
                }

                // Закрытие модального окна
                const modalCloseBtn = document.getElementById('news-modal-close');
                const modal = document.getElementById('news-detail-modal');
                
                if (modalCloseBtn) {
                    modalCloseBtn.addEventListener('click', () => {
                        this.closeNewsModal();
                    });
                }

                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeNewsModal();
                        }
                    });
                }

                // Обработчик переключения на вкладку новостей
                const newsTab = document.getElementById('tab-news');
                if (newsTab) {
                    newsTab.addEventListener('click', () => {
                        if (!this.hasLoadedInitialNews) {
                            this.loadNews();
                            this.hasLoadedInitialNews = true;
                        }
                    });
                }
            }

            async loadNews(page = 1, append = false) {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.showLoading();

                try {
                    const response = await fetch(`/api/news/?page=${page}&per_page=10`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (append) {
                        this.appendNews(data.news);
                    } else {
                        this.renderNews(data.news);
                    }

                    this.currentPage = page;
                    this.hasMore = data.has_more;
                    this.updateLoadMoreButton();

                } catch (error) {
                    console.error('Ошибка при загрузке новостей:', error);
                    this.showError('Не удалось загрузить новости. Попробуйте позже.');
                } finally {
                    this.isLoading = false;
                    this.hideLoading();
                }
            }

            async searchNews(query) {
                if (this.isLoading) return;

                this.searchQuery = query.trim();
                
                if (!this.searchQuery) {
                    this.loadNews();
                    return;
                }

                this.isLoading = true;
                this.showLoading();

                try {
                    const response = await fetch(`/api/news/search?q=${encodeURIComponent(this.searchQuery)}&limit=20`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    this.renderNews(data.news);
                    this.hasMore = false; // Поиск не поддерживает пагинацию
                    this.updateLoadMoreButton();

                } catch (error) {
                    console.error('Ошибка при поиске новостей:', error);
                    this.showError('Не удалось найти новости. Попробуйте позже.');
                } finally {
                    this.isLoading = false;
                    this.hideLoading();
                }
            }

            async loadMoreNews() {
                if (!this.hasMore || this.searchQuery) return;
                await this.loadNews(this.currentPage + 1, true);
            }

            renderNews(newsItems) {
                const newsList = document.getElementById('news-list');
                if (!newsList) return;

                if (!newsItems || newsItems.length === 0) {
                    this.showEmpty();
                    return;
                }

                newsList.innerHTML = newsItems.map(news => this.createNewsCard(news)).join('');
                this.hideEmpty();
            }

            appendNews(newsItems) {
                const newsList = document.getElementById('news-list');
                if (!newsList || !newsItems || newsItems.length === 0) return;

                const newsCardsHtml = newsItems.map(news => this.createNewsCard(news)).join('');
                newsList.insertAdjacentHTML('beforeend', newsCardsHtml);
            }

            createNewsCard(news) {
                // Создаем изображение с правильным соотношением сторон 1024:691
                let imageHtml = '';
                if (news.image_url) {
                    // Создаем контейнер с обработкой ошибок загрузки
                    const imageId = `news-img-${news.id}`;
                    // Используем image proxy для обхода CORS
                    const proxyImageUrl = `/api/news/image-proxy?url=${encodeURIComponent(news.image_url)}`;
                    imageHtml = `
                        <div class="news-image-container loading" id="${imageId}-container">
                            <img src="${proxyImageUrl}" 
                                 alt="${news.title}" 
                                 id="${imageId}"
                                 onerror="newsManager.handleImageError('${imageId}')"
                                 onload="newsManager.handleImageLoad('${imageId}')">
                            <div class="news-image-placeholder" style="display: none;">
                                📰<br>Изображение<br>недоступно
                            </div>
                        </div>
                    `;
                }

                const categoryHtml = news.category 
                    ? `<span class="news-category">${news.category}</span>`
                    : '';

                const dateFormatted = this.formatDate(news.date);

                return `
                    <div class="news-card" onclick="newsManager.openNewsDetail('${news.url}')">
                        <div class="news-card-header">
                            <h3 class="news-card-title">${news.title}</h3>
                            ${imageHtml}
                        </div>
                        <p class="news-card-excerpt">${news.excerpt}</p>
                        <div class="news-card-meta">
                            <div>
                                <span class="news-meta-date">${dateFormatted}</span>
                                ${news.author ? `<span class="news-meta-author">• ${news.author}</span>` : ''}
                            </div>
                            ${categoryHtml}
                        </div>
                    </div>
                `;
            }

            async openNewsDetail(newsUrl) {
                const modal = document.getElementById('news-detail-modal');
                const loadingEl = document.getElementById('news-detail-loading');
                const contentEl = document.getElementById('news-detail-content');
                const errorEl = document.getElementById('news-detail-error');

                if (!modal) return;

                // Показываем модальное окно
                modal.style.display = 'flex';
                loadingEl.style.display = 'block';
                contentEl.style.display = 'none';
                errorEl.style.display = 'none';

                try {
                    const response = await fetch(`/api/news/detail?url=${encodeURIComponent(newsUrl)}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Заполняем контент
                    document.getElementById('news-detail-title').textContent = data.title;
                    document.getElementById('news-detail-date').textContent = this.formatDate(data.date);
                    document.getElementById('news-detail-author').textContent = data.author || '';
                    
                    // Изображения
                    const imagesContainer = document.getElementById('news-detail-images');
                    if (data.images && data.images.length > 0) {
                        imagesContainer.innerHTML = data.images.map(img => {
                            // Используем image proxy для обхода CORS
                            const proxyImageUrl = `/api/news/image-proxy?url=${encodeURIComponent(img)}`;
                            return `<img src="${proxyImageUrl}" alt="Изображение" onerror="this.style.display='none'">`;
                        }).join('');
                        imagesContainer.style.display = 'block';
                    } else {
                        imagesContainer.style.display = 'none';
                    }

                    // Текст статьи
                    const textContainer = document.getElementById('news-detail-text');
                    textContainer.innerHTML = this.formatNewsContent(data.content);

                    // Показываем контент
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';

                } catch (error) {
                    console.error('Ошибка при загрузке детальной информации:', error);
                    loadingEl.style.display = 'none';
                    errorEl.style.display = 'block';
                }
            }

            closeNewsModal() {
                const modal = document.getElementById('news-detail-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            formatNewsContent(content) {
                if (!content) return '';
                
                // Если контент уже содержит HTML-теги, используем его как есть
                if (content.includes('<') && content.includes('>')) {
                    return content;
                }
                
                // Иначе разбиваем на параграфы и форматируем
                return content
                    .split('\n\n')
                    .filter(p => p.trim())
                    .map(p => `<p>${p.trim()}</p>`)
                    .join('');
            }

            formatDate(dateString) {
                if (!dateString) return '';
                
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return dateString; // Возвращаем как есть, если не удалось распарсить
                    }
                    
                    const now = new Date();
                    const diffTime = now - date;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        return 'Сегодня';
                    } else if (diffDays === 1) {
                        return 'Вчера';
                    } else if (diffDays < 7) {
                        return `${diffDays} дн. назад`;
                    } else {
                        return date.toLocaleDateString('ru-RU', {
                            day: 'numeric',
                            month: 'short',
                            year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
                        });
                    }
                } catch (error) {
                    return dateString;
                }
            }

            showLoading() {
                const loading = document.getElementById('news-loading');
                if (loading) loading.style.display = 'block';
            }

            hideLoading() {
                const loading = document.getElementById('news-loading');
                if (loading) loading.style.display = 'none';
            }

            showEmpty() {
                const empty = document.getElementById('news-empty');
                if (empty) empty.style.display = 'block';
            }

            hideEmpty() {
                const empty = document.getElementById('news-empty');
                if (empty) empty.style.display = 'none';
            }

            showError(message) {
                const newsList = document.getElementById('news-list');
                if (newsList) {
                    newsList.innerHTML = `
                        <div class="error-state">
                            <div class="error-icon">⚠️</div>
                            <h3>Ошибка</h3>
                            <p>${message}</p>
                        </div>
                    `;
                }
            }

            updateLoadMoreButton() {
                const container = document.querySelector('.news-load-more-container');
                if (container) {
                    container.style.display = this.hasMore && !this.searchQuery ? 'block' : 'none';
                }
            }

            handleImageLoad(imageId) {
                const container = document.getElementById(`${imageId}-container`);
                if (container) {
                    container.classList.remove('loading');
                }
                console.log('Изображение успешно загружено:', imageId);
            }

            handleImageError(imageId) {
                const container = document.getElementById(`${imageId}-container`);
                const img = document.getElementById(imageId);
                const placeholder = container?.querySelector('.news-image-placeholder');
                
                if (container && img && placeholder) {
                    container.classList.remove('loading');
                    img.style.display = 'none';
                    placeholder.style.display = 'block';
                }
                console.warn('Ошибка загрузки изображения:', imageId);
            }
        }

        // Инициализируем менеджер новостей
        const newsManager = new NewsManager();
        
        // Обработчики для модального окна карточки пары
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('pair-modal');
            const closeBtn = modal.querySelector('.pair-modal-close');
            const overlay = modal.querySelector('.pair-modal-overlay');
            
            // Закрытие по клику на кнопку закрытия
            closeBtn.addEventListener('click', closePairModal);
            
            // Закрытие по клику на overlay
            overlay.addEventListener('click', closePairModal);
            
            // Закрытие по нажатию Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    closePairModal();
                }
            });
            
            // Предотвращение закрытия при клике на содержимое модального окна
            modal.querySelector('.pair-modal-content').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Обработчики для модального окна управления пользователями
            const userModal = document.getElementById('user-management-modal');
            const userCloseBtn = userModal.querySelector('.user-management-modal-close');
            const userOverlay = userModal.querySelector('.user-management-modal-overlay');
            const manageUsersBtn = document.getElementById('manage-users-btn');
            const addUserBtn = document.getElementById('add-user-btn');
            
            // Открытие модального окна
            if (manageUsersBtn) {
                manageUsersBtn.addEventListener('click', function() {
                    authManager.showUserManagementModal();
                });
            }
            
            // Закрытие модального окна
            if (userCloseBtn) {
                userCloseBtn.addEventListener('click', function() {
                    authManager.closeUserManagementModal();
                });
            }
            
            if (userOverlay) {
                userOverlay.addEventListener('click', function() {
                    authManager.closeUserManagementModal();
                });
            }
            
            // Добавление пользователя
            if (addUserBtn) {
                addUserBtn.addEventListener('click', function() {
                    authManager.addUserToGroup();
                });
            }
            
            // Кнопка выхода
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    authManager.logout();
                });
            }
            
            // Кнопки администратора
            const manageAllGroupsBtn = document.getElementById('manage-all-groups-btn');
            if (manageAllGroupsBtn) {
                manageAllGroupsBtn.addEventListener('click', function() {
                    authManager.manageAllGroups();
                });
            }
            
            const assignMonitorBtn = document.getElementById('assign-monitor-btn');
            if (assignMonitorBtn) {
                assignMonitorBtn.addEventListener('click', function() {
                    authManager.assignMonitor();
                });
            }
            
            // Закрытие по Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && userModal.classList.contains('show')) {
                    authManager.closeUserManagementModal();
                }
            });
            
            // Предотвращение закрытия при клике на содержимое модального окна
            userModal.querySelector('.user-management-modal-content').addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    </script>
    <!-- Modal для карточки пары -->
    <div id="pair-modal" class="pair-modal">
        <div class="pair-modal-overlay"></div>
        <div class="pair-modal-content">
            <div class="pair-modal-header">
                <div class="pair-type-badge"></div>
                <div class="pair-time"></div>
                <button class="pair-modal-close" aria-label="Закрыть">&times;</button>
            </div>
            <div class="pair-modal-body">
                <h3 class="pair-title"></h3>
                <div class="pair-teacher"></div>
                <div class="pair-details">
                    <div class="pair-room"></div>
                    <div class="pair-notes"></div>
                </div>
                <div class="pair-homework-section" style="margin-top: 20px;">
                    <div class="pair-homework-display" style="display: none;">
                        <div class="homework-display">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">
                                <div style="flex: 1;">
                                    <strong>📝 Домашнее задание:</strong> <span class="homework-text"></span>
                                </div>
                                <div class="homework-actions" style="display: flex; gap: 0.25rem;">
                                    <button class="edit-homework-btn" style="
                                        background: none;
                                        border: none;
                                        color: var(--accent);
                                        cursor: pointer;
                                        padding: 0.25rem;
                                        border-radius: 4px;
                                        font-size: 0.8rem;
                                        opacity: 0.7;
                                        transition: opacity 0.2s;
                                    " title="Редактировать">✏️</button>
                                    <button class="delete-homework-btn" style="
                                        background: none;
                                        border: none;
                                        color: #ef4444;
                                        cursor: pointer;
                                        padding: 0.25rem;
                                        border-radius: 4px;
                                        font-size: 0.8rem;
                                        opacity: 0.7;
                                        transition: opacity 0.2s;
                                    " title="Удалить">🗑️</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pair-homework-add" style="display: none;">
                        <button class="add-homework-btn-modal" style="
                            padding: 0.5rem 1rem;
                            background: var(--accent);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 0.85rem;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            width: 100%;
                        ">Добавить домашнее задание</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal для управления пользователями -->
    <div id="user-management-modal" class="user-management-modal">
        <div class="user-management-modal-overlay"></div>
        <div class="user-management-modal-content">
            <div class="user-management-modal-header">
                <h3>Управление пользователями</h3>
                <button class="user-management-modal-close" aria-label="Закрыть">&times;</button>
            </div>
            <div class="user-management-modal-body">
                <div class="user-list" id="user-list">
                    <!-- Список пользователей будет загружен здесь -->
                </div>
                <div class="add-user-section">
                    <h4>Добавить пользователя в группу</h4>
                    <div class="add-user-form">
                        <input type="number" id="user-id-input" placeholder="ID пользователя Telegram" />
                        <select id="user-role-select">
                            <option value="student">Студент</option>
                            <option value="monitor">Староста</option>
                        </select>
                        <button id="add-user-btn">Добавить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal для управления уведомлениями -->
    <div id="notifications-modal" class="notifications-modal">
        <div class="notifications-modal-overlay"></div>
        <div class="notifications-modal-content">
            <div class="notifications-modal-header">
                <h3>🔔 Настройки уведомлений</h3>
                <button class="notifications-modal-close" aria-label="Закрыть">&times;</button>
            </div>
            <div class="notifications-modal-body">
                <div class="notifications-settings">
                    <!-- Общие настройки -->
                    <div class="notification-setting-group">
                        <h4>📢 Общие настройки</h4>
                        <div class="setting-item">
                            <label class="switch">
                                <input type="checkbox" id="notifications-enabled" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="setting-label">Включить уведомления</span>
                        </div>
                    </div>
                    
                    <!-- Типы уведомлений -->
                    <div class="notification-setting-group">
                        <h4>📝 Типы уведомлений</h4>
                        <div class="setting-item">
                            <label class="switch">
                                <input type="checkbox" id="homework-notifications" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="setting-label">Домашние задания</span>
                        </div>
                        <div class="setting-item">
                            <label class="switch">
                                <input type="checkbox" id="schedule-notifications" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="setting-label">Изменения расписания</span>
                        </div>
                        <div class="setting-item">
                            <label class="switch">
                                <input type="checkbox" id="group-notifications" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="setting-label">События группы</span>
                        </div>
                        <div class="setting-item">
                            <label class="switch">
                                <input type="checkbox" id="system-notifications" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="setting-label">Системные объявления</span>
                        </div>
                    </div>
                    
                    <!-- Время тишины -->
                    <div class="notification-setting-group">
                        <h4>🌙 Время тишины</h4>
                        <div class="quiet-hours-setting">
                            <div class="time-input-group">
                                <label>С</label>
                                <input type="time" id="quiet-hours-start" placeholder="22:00">
                            </div>
                            <div class="time-input-group">
                                <label>До</label>
                                <input type="time" id="quiet-hours-end" placeholder="08:00">
                            </div>
                            <p class="quiet-hours-help">
                                Уведомления не будут отправляться в указанное время
                            </p>
                        </div>
                    </div>
                    
                    <!-- История уведомлений -->
                    <div class="notification-setting-group">
                        <h4>📜 История уведомлений</h4>
                        <div class="notifications-history" id="notifications-history">
                            <p class="loading-text">Загрузка истории...</p>
                        </div>
                        <button id="load-more-notifications" class="btn-secondary">
                            Загрузить ещё
                        </button>
                    </div>
                </div>
                
                <!-- Кнопки -->
                <div class="notifications-modal-actions">
                    <button id="save-notifications-settings" class="btn-primary">Сохранить настройки</button>
                    <button id="test-notification-btn" class="btn-secondary">Тестовое уведомление</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal для отправки уведомлений (для админов) -->
    <div id="send-notification-modal" class="send-notification-modal">
        <div class="send-notification-modal-overlay"></div>
        <div class="send-notification-modal-content">
            <div class="send-notification-modal-header">
                <h3>💬 Отправить уведомление</h3>
                <button class="send-notification-modal-close" aria-label="Закрыть">&times;</button>
            </div>
            <div class="send-notification-modal-body">
                <form id="send-notification-form">
                    <div class="form-group">
                        <label for="notification-recipient">Получатель</label>
                        <select id="notification-recipient" required>
                            <option value="">Выберите адресата</option>
                            <option value="user">Конкретный пользователь</option>
                            <option value="group">Вся группа</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="user-selection-group" style="display: none;">
                        <label for="notification-user-id">ID пользователя</label>
                        <input type="number" id="notification-user-id" placeholder="Telegram ID пользователя">
                    </div>
                    
                    <div class="form-group" id="group-selection-group" style="display: none;">
                        <label for="notification-group-id">Группа</label>
                        <select id="notification-group-id">
                            <option value="">Выберите группу</option>
                            <!-- Группы загружаются через JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="notification-type">Тип уведомления</label>
                        <select id="notification-type" required>
                            <option value="system_announcement">📢 Системное объявление</option>
                            <option value="homework_assigned">📝 Новое домашнее задание</option>
                            <option value="schedule_changed">📅 Изменение расписания</option>
                            <option value="reminder">⏰ Напоминание</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="notification-title">Заголовок</label>
                        <input type="text" id="notification-title" required placeholder="Короткий заголовок" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="notification-message">Сообщение</label>
                        <textarea id="notification-message" required placeholder="Текст уведомления" rows="4" maxlength="1000"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-primary">Отправить уведомление</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- === СИСТЕМА УВЕДОМЛЕНИЙ JAVASCRIPT === -->
    <script>
    class NotificationManager {
        constructor() {
            this.settings = null;
            this.historyOffset = 0;
            this.historyLimit = 20;
        }

        async init() {
            // Добавляем кнопку настроек уведомлений в меню настроек
            this.addNotificationsButtonToSettings();
            
            // Инициализируем обработчики событий
            this.initEventHandlers();
            
            // Загружаем настройки
            await this.loadNotificationSettings();
        }

        addNotificationsButtonToSettings() {
            const settingsPanel = document.querySelector('.settings-panel');
            if (!settingsPanel) return;

            const notificationsEntry = document.createElement('div');
            notificationsEntry.className = 'menu-entry';
            notificationsEntry.innerHTML = `
                <div class="menu-icon">🔔</div>
                <span class="menu-text">Уведомления</span>
                <div class="menu-arrow">›</div>
            `;
            
            notificationsEntry.addEventListener('click', () => {
                this.openNotificationsModal();
            });

            // Вставляем перед разделителем или в конец
            const separator = settingsPanel.querySelector('.menu-separator');
            if (separator) {
                settingsPanel.insertBefore(notificationsEntry, separator);
            } else {
                settingsPanel.appendChild(notificationsEntry);
            }
        }

        initEventHandlers() {
            // Закрытие модальных окон
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('notifications-modal-overlay')) {
                    this.closeNotificationsModal();
                }
                if (e.target.classList.contains('send-notification-modal-overlay')) {
                    this.closeSendNotificationModal();
                }
            });

            // Кнопки закрытия
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('notifications-modal-close')) {
                    this.closeNotificationsModal();
                }
                if (e.target.classList.contains('send-notification-modal-close')) {
                    this.closeSendNotificationModal();
                }
            });

            // Сохранение настроек
            document.addEventListener('click', (e) => {
                if (e.target.id === 'save-notifications-settings') {
                    this.saveNotificationSettings();
                }
                if (e.target.id === 'test-notification-btn') {
                    this.sendTestNotification();
                }
                if (e.target.id === 'load-more-notifications') {
                    this.loadMoreNotifications();
                }
            });

            // Селектор получателя уведомления
            document.addEventListener('change', (e) => {
                if (e.target.id === 'notification-recipient') {
                    this.handleRecipientChange(e.target.value);
                }
            });

            // Отправка уведомления
            document.addEventListener('submit', (e) => {
                if (e.target.id === 'send-notification-form') {
                    e.preventDefault();
                    this.sendNotification(e.target);
                }
            });
        }

        getDefaultSettings() {
            return {
                user_id: 0,
                notifications_enabled: true,
                homework_notifications: true,
                schedule_notifications: true,
                group_notifications: true,
                system_notifications: true,
                reminder_notifications: true,
                quiet_hours_start: null,
                quiet_hours_end: null,
                language: 'ru'
            };
        }

        async loadNotificationSettings() {
            try {
                const initData = window.Telegram?.WebApp?.initData || '';
                
                // Если нет initData, загружаем из localStorage или используем настройки по умолчанию
                if (!initData) {
                    console.log('Telegram initData недоступен, загружаем локальные настройки');
                    
                    // Пытаемся загрузить сохраненные локальные настройки
                    const savedSettings = localStorage.getItem('notification-settings');
                    if (savedSettings) {
                        try {
                            const parsedSettings = JSON.parse(savedSettings);
                            this.settings = {
                                user_id: 0,
                                ...parsedSettings
                            };
                            console.log('Загружены локальные настройки:', parsedSettings);
                        } catch (e) {
                            console.error('Ошибка парсинга локальных настроек:', e);
                            this.settings = this.getDefaultSettings();
                        }
                    } else {
                        this.settings = this.getDefaultSettings();
                    }
                    
                    this.updateSettingsUI();
                    return;
                }

                const response = await fetch('/api/notifications/settings', {
                    headers: {
                        'X-Telegram-Init-Data': initData
                    }
                });

                if (!response.ok) {
                    console.warn('Не удалось загрузить настройки уведомлений:', response.status);
                    // Используем настройки по умолчанию при ошибке загрузки
                    this.settings = this.getDefaultSettings();
                    this.updateSettingsUI();
                    return;
                }

                this.settings = await response.json();
                this.updateSettingsUI();
                
            } catch (error) {
                console.error('Ошибка загрузки настроек уведомлений:', error);
                // Используем настройки по умолчанию при ошибке
                this.settings = this.getDefaultSettings();
                this.updateSettingsUI();
            }
        }

        updateSettingsUI() {
            if (!this.settings) return;

            document.getElementById('notifications-enabled').checked = this.settings.notifications_enabled;
            document.getElementById('homework-notifications').checked = this.settings.homework_notifications;
            document.getElementById('schedule-notifications').checked = this.settings.schedule_notifications;
            document.getElementById('group-notifications').checked = this.settings.group_notifications;
            document.getElementById('system-notifications').checked = this.settings.system_notifications;
            
            if (this.settings.quiet_hours_start) {
                document.getElementById('quiet-hours-start').value = this.settings.quiet_hours_start;
            }
            if (this.settings.quiet_hours_end) {
                document.getElementById('quiet-hours-end').value = this.settings.quiet_hours_end;
            }
        }

        async saveNotificationSettings() {
            try {
                const settingsData = {
                    notifications_enabled: document.getElementById('notifications-enabled').checked,
                    homework_notifications: document.getElementById('homework-notifications').checked,
                    schedule_notifications: document.getElementById('schedule-notifications').checked,
                    group_notifications: document.getElementById('group-notifications').checked,
                    system_notifications: document.getElementById('system-notifications').checked,
                    quiet_hours_start: document.getElementById('quiet-hours-start').value || null,
                    quiet_hours_end: document.getElementById('quiet-hours-end').value || null,
                    language: 'ru'
                };

                const initData = window.Telegram?.WebApp?.initData || '';
                
                // Если нет Telegram auth data, сохраняем настройки локально
                if (!initData) {
                    console.log('Telegram auth недоступен, настройки сохранены локально');
                    
                    // Обновляем локальные настройки
                    this.settings = {
                        user_id: 0,
                        ...settingsData
                    };
                    
                    // Сохраняем в localStorage для сохранения между сессиями
                    localStorage.setItem('notification-settings', JSON.stringify(settingsData));
                    
                    this.showNotification('Настройки уведомлений сохранены локально', 'success');
                    this.updateSettingsUI();
                    await this.loadNotificationHistory();
                    return;
                }

                const response = await fetch('/api/notifications/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': initData
                    },
                    body: JSON.stringify(settingsData)
                });

                if (response.ok) {
                    this.showNotification('Настройки уведомлений сохранены', 'success');
                    await this.loadNotificationSettings();
                    await this.loadNotificationHistory();
                } else {
                    console.warn('Сервер не доступен, сохраняем локально:', response.status);
                    localStorage.setItem('notification-settings', JSON.stringify(settingsData));
                    this.showNotification('Настройки сохранены локально', 'info');
                }

            } catch (error) {
                console.error('Ошибка сохранения настроек уведомлений:', error);
                // Fallback - сохраняем локально
                const settingsData = {
                    notifications_enabled: document.getElementById('notifications-enabled').checked,
                    homework_notifications: document.getElementById('homework-notifications').checked,
                    schedule_notifications: document.getElementById('schedule-notifications').checked,
                    group_notifications: document.getElementById('group-notifications').checked,
                    system_notifications: document.getElementById('system-notifications').checked,
                    quiet_hours_start: document.getElementById('quiet-hours-start').value || null,
                    quiet_hours_end: document.getElementById('quiet-hours-end').value || null,
                    language: 'ru'
                };
                localStorage.setItem('notification-settings', JSON.stringify(settingsData));
                this.showNotification('Настройки сохранены локально', 'success');
            }
        }

        async loadNotificationHistory() {
            const historyContainer = document.getElementById('notifications-history');
            if (!historyContainer) return;

            historyContainer.innerHTML = '<p class="loading-text">Загрузка истории...</p>';

            try {
                const initData = window.Telegram?.WebApp?.initData || '';
                
                // Если нет Telegram auth, показываем сообщение что история недоступна
                if (!initData) {
                    historyContainer.innerHTML = '<p class="loading-text">История уведомлений доступна только в Telegram</p>';
                    const loadMoreBtn = document.getElementById('load-more-notifications');
                    if (loadMoreBtn) {
                        loadMoreBtn.style.display = 'none';
                    }
                    return;
                }

                const response = await fetch(`/api/notifications/history?limit=${this.historyLimit}&offset=${this.historyOffset}`, {
                    headers: {
                        'X-Telegram-Init-Data': initData
                    }
                });

                if (!response.ok) {
                    historyContainer.innerHTML = '<p class="loading-text">Не удалось загрузить историю</p>';
                    return;
                }

                const data = await response.json();
                this.renderNotificationHistory(data.notifications);

                // Показываем/скрываем кнопку "Загрузить ещё"
                const loadMoreBtn = document.getElementById('load-more-notifications');
                if (loadMoreBtn) {
                    loadMoreBtn.style.display = data.notifications.length === this.historyLimit ? 'block' : 'none';
                }

            } catch (error) {
                console.error('Ошибка загрузки истории уведомлений:', error);
                historyContainer.innerHTML = '<p class="loading-text">Ошибка загрузки истории</p>';
            }
        }

        renderNotificationHistory(notifications) {
            const historyContainer = document.getElementById('notifications-history');
            if (!historyContainer) return;

            if (notifications.length === 0) {
                historyContainer.innerHTML = '<p class="loading-text">История уведомлений пуста</p>';
                return;
            }

            const historyHTML = notifications.map(notification => {
                const createdDate = new Date(notification.created_at);
                const sentStatus = notification.sent ? '✅ Отправлено' : '⏳ Ожидает отправки';
                const sentClass = notification.sent ? 'sent' : 'pending';

                return `
                    <div class="notification-item ${!notification.sent ? 'unread' : ''}">
                        <div class="notification-item-header">
                            <div class="notification-title">${this.escapeHtml(notification.title)}</div>
                            <div class="notification-time">${createdDate.toLocaleString('ru-RU')}</div>
                        </div>
                        <div class="notification-message">${this.escapeHtml(notification.message)}</div>
                        <div class="notification-status ${sentClass}">${sentStatus}</div>
                    </div>
                `;
            }).join('');

            if (this.historyOffset === 0) {
                historyContainer.innerHTML = historyHTML;
            } else {
                historyContainer.insertAdjacentHTML('beforeend', historyHTML);
            }
        }

        async loadMoreNotifications() {
            this.historyOffset += this.historyLimit;
            await this.loadNotificationHistory();
        }

        async sendTestNotification() {
            try {
                const currentUser = window.authManager?.currentUser;
                if (!currentUser) {
                    this.showNotification('Ошибка: пользователь не авторизован', 'error');
                    return;
                }

                const initData = window.Telegram?.WebApp?.initData || '';
                const response = await fetch('/api/admin/notifications/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': initData
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        type: 'system_announcement',
                        title: 'Тестовое уведомление',
                        message: 'Это тестовое уведомление для проверки настроек. Если вы видите его, значит система уведомлений работает правильно! 🔔'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    this.showNotification(`Тестовое уведомление отправлено!`, 'success');
                    
                    // Обновляем историю
                    setTimeout(() => this.loadNotificationHistory(), 1000);
                } else {
                    throw new Error('Ошибка отправки тестового уведомления');
                }

            } catch (error) {
                console.error('Ошибка отправки тестового уведомления:', error);
                this.showNotification('Ошибка отправки тестового уведомления', 'error');
            }
        }

        handleRecipientChange(recipientType) {
            const userGroup = document.getElementById('user-selection-group');
            const groupGroup = document.getElementById('group-selection-group');

            userGroup.style.display = recipientType === 'user' ? 'block' : 'none';
            groupGroup.style.display = recipientType === 'group' ? 'block' : 'none';

            if (recipientType === 'group') {
                this.loadGroups();
            }
        }

        async loadGroups() {
            const groupSelect = document.getElementById('notification-group-id');
            if (!groupSelect || groupSelect.options.length > 1) return; // Уже загружены группы

            try {
                const initData = window.Telegram?.WebApp?.initData || '';
                const response = await fetch('/api/groups', {
                    headers: {
                        'X-Telegram-Init-Data': initData
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    data.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.name;
                        groupSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки групп:', error);
            }
        }

        async sendNotification(form) {
            try {
                const recipientType = document.getElementById('notification-recipient').value;
                const notificationData = {
                    type: document.getElementById('notification-type').value,
                    title: document.getElementById('notification-title').value,
                    message: document.getElementById('notification-message').value
                };

                if (recipientType === 'user') {
                    const userId = document.getElementById('notification-user-id').value;
                    if (!userId) {
                        this.showNotification('Введите ID пользователя', 'error');
                        return;
                    }
                    notificationData.user_id = parseInt(userId);
                } else {
                    const groupId = document.getElementById('notification-group-id').value;
                    if (!groupId) {
                        this.showNotification('Выберите группу', 'error');
                        return;
                    }
                    notificationData.group_id = groupId;
                }

                const initData = window.Telegram?.WebApp?.initData || '';
                const response = await fetch('/api/admin/notifications/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': initData
                    },
                    body: JSON.stringify(notificationData)
                });

                if (response.ok) {
                    const result = await response.json();
                    this.showNotification(`Уведомление отправлено! (${result.sent_count} успешно, ${result.failed_count} ошибок)`, 'success');
                    this.closeSendNotificationModal();
                    form.reset();
                } else {
                    throw new Error('Ошибка отправки уведомления');
                }

            } catch (error) {
                console.error('Ошибка отправки уведомления:', error);
                this.showNotification('Ошибка отправки уведомления', 'error');
            }
        }

        openNotificationsModal() {
            const modal = document.getElementById('notifications-modal');
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // Сбрасываем offset и загружаем историю
                this.historyOffset = 0;
                this.loadNotificationHistory();
            }
        }

        closeNotificationsModal() {
            const modal = document.getElementById('notifications-modal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        openSendNotificationModal() {
            const modal = document.getElementById('send-notification-modal');
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        closeSendNotificationModal() {
            const modal = document.getElementById('send-notification-modal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        showNotification(message, type = 'info') {
            // Используем существующую систему уведомлений
            if (window.authManager && window.authManager.showNotification) {
                window.authManager.showNotification(message, type);
            } else {
                alert(message);
            }
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    // Добавляем кнопку отправки уведомлений в админскую панель
    function addAdminNotificationButton() {
        const adminPanel = document.querySelector('.admin-panel');
        if (!adminPanel) return;

        const notificationsBtn = document.createElement('button');
        notificationsBtn.className = 'admin-button';
        notificationsBtn.innerHTML = '🔔 Отправить уведомление';
        notificationsBtn.addEventListener('click', () => {
            if (window.notificationManager) {
                window.notificationManager.openSendNotificationModal();
            }
        });

        adminPanel.appendChild(notificationsBtn);
    }

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', () => {
        // Ждем создания authManager
        setTimeout(() => {
            window.notificationManager = new NotificationManager();
            window.notificationManager.init();
            
            // Добавляем кнопку в админ-панель если это админ
            if (window.authManager?.currentUser?.role === 'admin') {
                addAdminNotificationButton();
            }
        }, 1000);
    });

    // Обновляем addAdminNotificationButton при смене пользователя
    const originalSetAuthenticatedUser = window.ChatApp?.prototype.setAuthenticatedUser;
    if (originalSetAuthenticatedUser) {
        window.ChatApp.prototype.setAuthenticatedUser = function(user, options = {}) {
            originalSetAuthenticatedUser.call(this, user, options);
            
            // Добавляем кнопку уведомлений для админов
            if (user.role === 'admin') {
                setTimeout(addAdminNotificationButton, 100);
            }
        };
    }
    </script>

    </body>
</html>
